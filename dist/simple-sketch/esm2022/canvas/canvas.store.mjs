import { Injectable, inject } from '@angular/core';
import { ComponentStore } from '@ngrx/component-store';
import { BehaviorSubject, combineLatest, debounceTime, filter, fromEvent, of, switchMap, takeUntil, tap, } from 'rxjs';
import { WINDOW } from '../injection-tokens';
import * as i0 from "@angular/core";
export var Mode;
(function (Mode) {
    Mode["ERASE"] = "erase";
    Mode["SKETCH"] = "sketch";
})(Mode || (Mode = {}));
const INITIAL_STATE = {
    backgroundColor: '#000000',
    canvasOffsetX: 0,
    canvasOffsetY: 0,
    isSketching: false,
    lineWidth: 5,
    mode: Mode.SKETCH,
    paintColor: '#ffffff',
    startX: 0,
    startY: 0,
};
export class SimpleSketchCanvasStore extends ComponentStore {
    canvas$ = new BehaviorSubject(null);
    context$ = new BehaviorSubject(null);
    window = inject(WINDOW);
    /**
     * +-------------------------------------------+
     * SELECTORS
     * +-------------------------------------------+
     */
    backgroundColor$ = this.select(state => state.backgroundColor);
    paintColor$ = this.select(state => state.paintColor);
    canvasOffsetX$ = this.select(state => state.canvasOffsetX);
    canvasOffsetY$ = this.select(state => state.canvasOffsetY);
    isSketching$ = this.select(state => state.isSketching);
    lineWidth$ = this.select(state => state.lineWidth);
    mode$ = this.select(state => state.mode);
    /**
     * +-------------------------------------------+
     * UPDATERS
     * +-------------------------------------------+
     */
    updateBackGroundColor = this.updater((state, newBackgroundColor) => ({
        ...state,
        backgroundColor: newBackgroundColor,
    }));
    updateIsSketching = this.updater((state, isSketching) => ({
        ...state,
        isSketching,
    }));
    updateCanvasOffsetX = this.updater((state, newCanvasOffsetX) => ({
        ...state,
        canvasOffsetX: newCanvasOffsetX,
    }));
    updateCanvasOffsetY = this.updater((state, newCanvasOffsetY) => ({
        ...state,
        canvasOffsetY: newCanvasOffsetY,
    }));
    updatePaintColor = this.updater((state, newPaintColor) => ({
        ...state,
        paintColor: newPaintColor,
    }));
    updateMode = this.updater((state, newMode) => ({
        ...state,
        mode: newMode,
    }));
    updateStartX = this.updater((state, newStartX) => ({
        ...state,
        startX: newStartX,
    }));
    updateStartY = this.updater((state, newStartY) => ({
        ...state,
        startY: newStartY,
    }));
    /**
     * +-------------------------------------------+
     * EFFECTS
     * +-------------------------------------------+
     */
    applyBackgroundColor = this.effect(() => {
        return combineLatest([this.backgroundColor$, this.canvas$]).pipe(tap(([color, canvas]) => {
            if (canvas) {
                canvas.style.backgroundColor = color;
            }
        }));
    });
    clearCanvas = this.effect(trigger$ => combineLatest([trigger$, this.context$, this.canvas$]).pipe(tap(([, context, canvas]) => {
        if (context && canvas) {
            context.clearRect(0, 0, canvas.width, canvas.height);
        }
    })));
    init = this.effect((data$) => {
        return data$.pipe(tap(([canvas, backgroundColor, paintColor]) => {
            const context = canvas.getContext('2d');
            this.canvas$.next(canvas);
            this.context$.next(context);
            const hostElement = canvas.parentElement;
            this.updateCanvasSize([
                hostElement.offsetWidth,
                hostElement.offsetHeight,
            ]);
            this.updateCanvasOffsetX(canvas.offsetLeft);
            this.updateCanvasOffsetY(canvas.offsetTop);
            this.updateBackGroundColor(backgroundColor);
            this.updatePaintColor(paintColor);
            this.applyBackgroundColor();
            fromEvent(this.window, 'resize')
                .pipe(takeUntil(this.destroy$), debounceTime(75))
                .subscribe(() => {
                this.updateCanvasSize([
                    hostElement.offsetWidth,
                    hostElement.offsetHeight,
                ]);
            });
        }));
    });
    sketch = this.effect((event$) => {
        return combineLatest([
            event$,
            this.context$,
            this.isSketching$,
            this.lineWidth$,
            this.canvasOffsetX$,
            this.canvasOffsetY$,
            this.paintColor$,
            this.mode$,
        ]).pipe(tap(([event, context, isSketching, lineWidth, canvasOffsetX, canvasOffsetY, paintColor, mode,]) => {
            if (!isSketching || context === null)
                return;
            context.globalCompositeOperation =
                mode === Mode.SKETCH ? 'source-over' : 'destination-out';
            context.lineWidth =
                mode === Mode.SKETCH ? lineWidth : lineWidth * 1.7;
            context.lineCap = 'round';
            context.strokeStyle = paintColor;
            const screenPosition = this.eventPosition(event);
            context.lineTo(screenPosition.x - canvasOffsetX, screenPosition.y - canvasOffsetY);
            context.stroke();
        }));
    });
    startSketch = this.effect((event$) => {
        return event$.pipe(tap(event => {
            const screenPosition = this.eventPosition(event);
            this.updateIsSketching(true);
            this.updateStartX(screenPosition.x);
            this.updateStartY(screenPosition.y);
        }));
    });
    stopSketch = this.effect((event$) => {
        return combineLatest([event$, this.context$]).pipe(tap(([, context]) => {
            this.updateIsSketching(false);
            if (context === null)
                return;
            context.stroke();
            context.beginPath();
        }));
    });
    updateCanvasSize = this.effect((args$) => {
        return args$.pipe(switchMap(([width, height]) => {
            return combineLatest([
                this.canvas$,
                this.context$,
                of(width),
                of(height),
            ]);
        }), filter(
        /* eslint-disable @typescript-eslint/no-unused-vars */
        ([canvas, context, width, height]) => canvas !== null && context !== null), tap(([canvas, context, width, height]) => {
            // Resizing the canvas will clear its contents, so store the current
            // canvas contents before resizing so they can be restored after.
            const currentCanvasContent = context.getImageData(0, 0, canvas.width, canvas.height);
            // Now resize the canvas
            canvas.width = width;
            canvas.height = height;
            // Reapply saved contents/
            context.putImageData(currentCanvasContent, 0, 0);
        }));
    });
    /**
     * +-------------------------------------------+
     * CLASS METHODS
     * +-------------------------------------------+
     */
    /**
     * Takes a mousemove or touchmove event and return the corresponding position
     * on the screen where the event occurred.
     */
    eventPosition(event) {
        const isTouchEvent = event instanceof TouchEvent;
        const newX = isTouchEvent
            ? event.touches[0].pageX
            : event.clientX;
        const newY = isTouchEvent
            ? event.touches[0].pageY
            : event.clientY;
        return {
            x: newX,
            y: newY,
        };
    }
    constructor() {
        super(INITIAL_STATE);
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: SimpleSketchCanvasStore, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
    static ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: SimpleSketchCanvasStore });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: SimpleSketchCanvasStore, decorators: [{
            type: Injectable
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLnN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NpbXBsZS1za2V0Y2gvY2FudmFzL2NhbnZhcy5zdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFDckQsT0FBTyxFQUNMLGVBQWUsRUFFZixhQUFhLEVBQ2IsWUFBWSxFQUNaLE1BQU0sRUFDTixTQUFTLEVBQ1QsRUFBRSxFQUNGLFNBQVMsRUFDVCxTQUFTLEVBQ1QsR0FBRyxHQUNKLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLHFCQUFxQixDQUFDOztBQUUzQyxNQUFNLENBQU4sSUFBWSxJQUdYO0FBSEQsV0FBWSxJQUFJO0lBQ2QsdUJBQWUsQ0FBQTtJQUNmLHlCQUFpQixDQUFBO0FBQ25CLENBQUMsRUFIVyxJQUFJLEtBQUosSUFBSSxRQUdmO0FBY0QsTUFBTSxhQUFhLEdBQTRCO0lBQzdDLGVBQWUsRUFBRSxTQUFTO0lBQzFCLGFBQWEsRUFBRSxDQUFDO0lBQ2hCLGFBQWEsRUFBRSxDQUFDO0lBQ2hCLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLFNBQVMsRUFBRSxDQUFDO0lBQ1osSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNO0lBQ2pCLFVBQVUsRUFBRSxTQUFTO0lBQ3JCLE1BQU0sRUFBRSxDQUFDO0lBQ1QsTUFBTSxFQUFFLENBQUM7Q0FDVixDQUFDO0FBR0YsTUFBTSxPQUFPLHVCQUF3QixTQUFRLGNBQXVDO0lBQzFFLE9BQU8sR0FBRyxJQUFJLGVBQWUsQ0FBMkIsSUFBSSxDQUFDLENBQUM7SUFDOUQsUUFBUSxHQUFHLElBQUksZUFBZSxDQUFrQyxJQUFJLENBQUMsQ0FBQztJQUN0RSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FB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dUI7a0JBRG5DLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGUsIGluamVjdH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0NvbXBvbmVudFN0b3JlfSBmcm9tICdAbmdyeC9jb21wb25lbnQtc3RvcmUnO1xuaW1wb3J0IHtcbiAgQmVoYXZpb3JTdWJqZWN0LFxuICBPYnNlcnZhYmxlLFxuICBjb21iaW5lTGF0ZXN0LFxuICBkZWJvdW5jZVRpbWUsXG4gIGZpbHRlcixcbiAgZnJvbUV2ZW50LFxuICBvZixcbiAgc3dpdGNoTWFwLFxuICB0YWtlVW50aWwsXG4gIHRhcCxcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1dJTkRPV30gZnJvbSAnLi4vaW5qZWN0aW9uLXRva2Vucyc7XG5cbmV4cG9ydCBlbnVtIE1vZGUge1xuICBFUkFTRSA9ICdlcmFzZScsXG4gIFNLRVRDSCA9ICdza2V0Y2gnLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNpbXBsZVNrZXRjaENhbnZhc1N0YXRlIHtcbiAgYmFja2dyb3VuZENvbG9yOiBzdHJpbmc7XG4gIGNhbnZhc09mZnNldFg6IG51bWJlcjtcbiAgY2FudmFzT2Zmc2V0WTogbnVtYmVyO1xuICBpc1NrZXRjaGluZzogYm9vbGVhbjtcbiAgbGluZVdpZHRoOiBudW1iZXI7XG4gIG1vZGU6IE1vZGU7XG4gIHBhaW50Q29sb3I6IHN0cmluZztcbiAgc3RhcnRYOiBudW1iZXI7XG4gIHN0YXJ0WTogbnVtYmVyO1xufVxuXG5jb25zdCBJTklUSUFMX1NUQVRFOiBTaW1wbGVTa2V0Y2hDYW52YXNTdGF0ZSA9IHtcbiAgYmFja2dyb3VuZENvbG9yOiAnIzAwMDAwMCcsXG4gIGNhbnZhc09mZnNldFg6IDAsXG4gIGNhbnZhc09mZnNldFk6IDAsXG4gIGlzU2tldGNoaW5nOiBmYWxzZSxcbiAgbGluZVdpZHRoOiA1LFxuICBtb2RlOiBNb2RlLlNLRVRDSCxcbiAgcGFpbnRDb2xvcjogJyNmZmZmZmYnLFxuICBzdGFydFg6IDAsXG4gIHN0YXJ0WTogMCxcbn07XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTaW1wbGVTa2V0Y2hDYW52YXNTdG9yZSBleHRlbmRzIENvbXBvbmVudFN0b3JlPFNpbXBsZVNrZXRjaENhbnZhc1N0YXRlPiB7XG4gIHByaXZhdGUgY2FudmFzJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8SFRNTENhbnZhc0VsZW1lbnQgfCBudWxsPihudWxsKTtcbiAgcHJpdmF0ZSBjb250ZXh0JCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8Q2FudmFzUmVuZGVyaW5nQ29udGV4dDJEIHwgbnVsbD4obnVsbCk7XG4gIHByaXZhdGUgd2luZG93ID0gaW5qZWN0KFdJTkRPVyk7XG5cbiAgLyoqXG4gICAqICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tK1xuICAgKiBTRUxFQ1RPUlNcbiAgICogKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rXG4gICAqL1xuICByZWFkb25seSBiYWNrZ3JvdW5kQ29sb3IkOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLnNlbGVjdChcbiAgICBzdGF0ZSA9PiBzdGF0ZS5iYWNrZ3JvdW5kQ29sb3JcbiAgKTtcblxuICByZWFkb25seSBwYWludENvbG9yJDogT2JzZXJ2YWJsZTxzdHJpbmc+ID0gdGhpcy5zZWxlY3QoXG4gICAgc3RhdGUgPT4gc3RhdGUucGFpbnRDb2xvclxuICApO1xuXG4gIHJlYWRvbmx5IGNhbnZhc09mZnNldFgkOiBPYnNlcnZhYmxlPG51bWJlcj4gPSB0aGlzLnNlbGVjdChcbiAgICBzdGF0ZSA9PiBzdGF0ZS5jYW52YXNPZmZzZXRYXG4gICk7XG5cbiAgcmVhZG9ubHkgY2FudmFzT2Zmc2V0WSQ6IE9ic2VydmFibGU8bnVtYmVyPiA9IHRoaXMuc2VsZWN0KFxuICAgIHN0YXRlID0+IHN0YXRlLmNhbnZhc09mZnNldFlcbiAgKTtcblxuICByZWFkb25seSBpc1NrZXRjaGluZyQ6IE9ic2VydmFibGU8Ym9vbGVhbj4gPSB0aGlzLnNlbGVjdChcbiAgICBzdGF0ZSA9PiBzdGF0ZS5pc1NrZXRjaGluZ1xuICApO1xuXG4gIHJlYWRvbmx5IGxpbmVXaWR0aCQ6IE9ic2VydmFibGU8bnVtYmVyPiA9IHRoaXMuc2VsZWN0KFxuICAgIHN0YXRlID0+IHN0YXRlLmxpbmVXaWR0aFxuICApO1xuXG4gIHJlYWRvbmx5IG1vZGUkOiBPYnNlcnZhYmxlPE1vZGU+ID0gdGhpcy5zZWxlY3Qoc3RhdGUgPT4gc3RhdGUubW9kZSk7XG5cbiAgLyoqXG4gICAqICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tK1xuICAgKiBVUERBVEVSU1xuICAgKiArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLStcbiAgICovXG4gIHJlYWRvbmx5IHVwZGF0ZUJhY2tHcm91bmRDb2xvciA9IHRoaXMudXBkYXRlcihcbiAgICAoc3RhdGUsIG5ld0JhY2tncm91bmRDb2xvcjogc3RyaW5nKSA9PiAoe1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBiYWNrZ3JvdW5kQ29sb3I6IG5ld0JhY2tncm91bmRDb2xvcixcbiAgICB9KVxuICApO1xuXG4gIHJlYWRvbmx5IHVwZGF0ZUlzU2tldGNoaW5nID0gdGhpcy51cGRhdGVyKChzdGF0ZSwgaXNTa2V0Y2hpbmc6IGJvb2xlYW4pID0+ICh7XG4gICAgLi4uc3RhdGUsXG4gICAgaXNTa2V0Y2hpbmcsXG4gIH0pKTtcblxuICByZWFkb25seSB1cGRhdGVDYW52YXNPZmZzZXRYID0gdGhpcy51cGRhdGVyKFxuICAgIChzdGF0ZSwgbmV3Q2FudmFzT2Zmc2V0WDogbnVtYmVyKSA9PiAoe1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBjYW52YXNPZmZzZXRYOiBuZXdDYW52YXNPZmZzZXRYLFxuICAgIH0pXG4gICk7XG5cbiAgcmVhZG9ubHkgdXBkYXRlQ2FudmFzT2Zmc2V0WSA9IHRoaXMudXBkYXRlcihcbiAgICAoc3RhdGUsIG5ld0NhbnZhc09mZnNldFk6IG51bWJlcikgPT4gKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgY2FudmFzT2Zmc2V0WTogbmV3Q2FudmFzT2Zmc2V0WSxcbiAgICB9KVxuICApO1xuXG4gIHJlYWRvbmx5IHVwZGF0ZVBhaW50Q29sb3IgPSB0aGlzLnVwZGF0ZXIoKHN0YXRlLCBuZXdQYWludENvbG9yOiBzdHJpbmcpID0+ICh7XG4gICAgLi4uc3RhdGUsXG4gICAgcGFpbnRDb2xvcjogbmV3UGFpbnRDb2xvcixcbiAgfSkpO1xuXG4gIHJlYWRvbmx5IHVwZGF0ZU1vZGUgPSB0aGlzLnVwZGF0ZXIoKHN0YXRlLCBuZXdNb2RlOiBNb2RlKSA9PiAoe1xuICAgIC4uLnN0YXRlLFxuICAgIG1vZGU6IG5ld01vZGUsXG4gIH0pKTtcblxuICByZWFkb25seSB1cGRhdGVTdGFydFggPSB0aGlzLnVwZGF0ZXIoKHN0YXRlLCBuZXdTdGFydFg6IG51bWJlcikgPT4gKHtcbiAgICAuLi5zdGF0ZSxcbiAgICBzdGFydFg6IG5ld1N0YXJ0WCxcbiAgfSkpO1xuXG4gIHJlYWRvbmx5IHVwZGF0ZVN0YXJ0WSA9IHRoaXMudXBkYXRlcigoc3RhdGUsIG5ld1N0YXJ0WTogbnVtYmVyKSA9PiAoe1xuICAgIC4uLnN0YXRlLFxuICAgIHN0YXJ0WTogbmV3U3RhcnRZLFxuICB9KSk7XG5cbiAgLyoqXG4gICAqICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tK1xuICAgKiBFRkZFQ1RTXG4gICAqICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tK1xuICAgKi9cbiAgcmVhZG9ubHkgYXBwbHlCYWNrZ3JvdW5kQ29sb3IgPSB0aGlzLmVmZmVjdCgoKSA9PiB7XG4gICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW3RoaXMuYmFja2dyb3VuZENvbG9yJCwgdGhpcy5jYW52YXMkXSkucGlwZShcbiAgICAgIHRhcCgoW2NvbG9yLCBjYW52YXNdKSA9PiB7XG4gICAgICAgIGlmIChjYW52YXMpIHtcbiAgICAgICAgICBjYW52YXMuc3R5bGUuYmFja2dyb3VuZENvbG9yID0gY29sb3I7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfSk7XG5cbiAgcmVhZG9ubHkgY2xlYXJDYW52YXMgPSB0aGlzLmVmZmVjdCh0cmlnZ2VyJCA9PlxuICAgIGNvbWJpbmVMYXRlc3QoW3RyaWdnZXIkLCB0aGlzLmNvbnRleHQkLCB0aGlzLmNhbnZhcyRdKS5waXBlKFxuICAgICAgdGFwKChbLCBjb250ZXh0LCBjYW52YXNdKSA9PiB7XG4gICAgICAgIGlmIChjb250ZXh0ICYmIGNhbnZhcykge1xuICAgICAgICAgIGNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIGNhbnZhcy53aWR0aCwgY2FudmFzLmhlaWdodCk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKVxuICApO1xuXG4gIHJlYWRvbmx5IGluaXQgPSB0aGlzLmVmZmVjdChcbiAgICAoZGF0YSQ6IE9ic2VydmFibGU8W0hUTUxDYW52YXNFbGVtZW50LCBzdHJpbmcsIHN0cmluZ10+KSA9PiB7XG4gICAgICByZXR1cm4gZGF0YSQucGlwZShcbiAgICAgICAgdGFwKChbY2FudmFzLCBiYWNrZ3JvdW5kQ29sb3IsIHBhaW50Q29sb3JdKSA9PiB7XG4gICAgICAgICAgY29uc3QgY29udGV4dCA9IGNhbnZhcy5nZXRDb250ZXh0KCcyZCcpO1xuXG4gICAgICAgICAgdGhpcy5jYW52YXMkLm5leHQoY2FudmFzKTtcbiAgICAgICAgICB0aGlzLmNvbnRleHQkLm5leHQoY29udGV4dCk7XG5cbiAgICAgICAgICBjb25zdCBob3N0RWxlbWVudCA9IGNhbnZhcy5wYXJlbnRFbGVtZW50IGFzIEhUTUxFbGVtZW50O1xuICAgICAgICAgIHRoaXMudXBkYXRlQ2FudmFzU2l6ZShbXG4gICAgICAgICAgICBob3N0RWxlbWVudC5vZmZzZXRXaWR0aCxcbiAgICAgICAgICAgIGhvc3RFbGVtZW50Lm9mZnNldEhlaWdodCxcbiAgICAgICAgICBdKTtcblxuICAgICAgICAgIHRoaXMudXBkYXRlQ2FudmFzT2Zmc2V0WChjYW52YXMub2Zmc2V0TGVmdCk7XG4gICAgICAgICAgdGhpcy51cGRhdGVDYW52YXNPZmZzZXRZKGNhbnZhcy5vZmZzZXRUb3ApO1xuICAgICAgICAgIHRoaXMudXBkYXRlQmFja0dyb3VuZENvbG9yKGJhY2tncm91bmRDb2xvcik7XG4gICAgICAgICAgdGhpcy51cGRhdGVQYWludENvbG9yKHBhaW50Q29sb3IpO1xuXG4gICAgICAgICAgdGhpcy5hcHBseUJhY2tncm91bmRDb2xvcigpO1xuXG4gICAgICAgICAgZnJvbUV2ZW50KHRoaXMud2luZG93LCAncmVzaXplJylcbiAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSwgZGVib3VuY2VUaW1lKDc1KSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgICAgICAgICB0aGlzLnVwZGF0ZUNhbnZhc1NpemUoW1xuICAgICAgICAgICAgICAgIGhvc3RFbGVtZW50Lm9mZnNldFdpZHRoLFxuICAgICAgICAgICAgICAgIGhvc3RFbGVtZW50Lm9mZnNldEhlaWdodCxcbiAgICAgICAgICAgICAgXSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICApO1xuXG4gIHJlYWRvbmx5IHNrZXRjaCA9IHRoaXMuZWZmZWN0KFxuICAgIChldmVudCQ6IE9ic2VydmFibGU8TW91c2VFdmVudCB8IFRvdWNoRXZlbnQ+KSA9PiB7XG4gICAgICByZXR1cm4gY29tYmluZUxhdGVzdChbXG4gICAgICAgIGV2ZW50JCxcbiAgICAgICAgdGhpcy5jb250ZXh0JCxcbiAgICAgICAgdGhpcy5pc1NrZXRjaGluZyQsXG4gICAgICAgIHRoaXMubGluZVdpZHRoJCxcbiAgICAgICAgdGhpcy5jYW52YXNPZmZzZXRYJCxcbiAgICAgICAgdGhpcy5jYW52YXNPZmZzZXRZJCxcbiAgICAgICAgdGhpcy5wYWludENvbG9yJCxcbiAgICAgICAgdGhpcy5tb2RlJCxcbiAgICAgIF0pLnBpcGUoXG4gICAgICAgIHRhcChcbiAgICAgICAgICAoW1xuICAgICAgICAgICAgZXZlbnQsXG4gICAgICAgICAgICBjb250ZXh0LFxuICAgICAgICAgICAgaXNTa2V0Y2hpbmcsXG4gICAgICAgICAgICBsaW5lV2lkdGgsXG4gICAgICAgICAgICBjYW52YXNPZmZzZXRYLFxuICAgICAgICAgICAgY2FudmFzT2Zmc2V0WSxcbiAgICAgICAgICAgIHBhaW50Q29sb3IsXG4gICAgICAgICAgICBtb2RlLFxuICAgICAgICAgIF0pID0+IHtcbiAgICAgICAgICAgIGlmICghaXNTa2V0Y2hpbmcgfHwgY29udGV4dCA9PT0gbnVsbCkgcmV0dXJuO1xuICAgICAgICAgICAgY29udGV4dC5nbG9iYWxDb21wb3NpdGVPcGVyYXRpb24gPVxuICAgICAgICAgICAgICBtb2RlID09PSBNb2RlLlNLRVRDSCA/ICdzb3VyY2Utb3ZlcicgOiAnZGVzdGluYXRpb24tb3V0JztcbiAgICAgICAgICAgIGNvbnRleHQubGluZVdpZHRoID1cbiAgICAgICAgICAgICAgbW9kZSA9PT0gTW9kZS5TS0VUQ0ggPyBsaW5lV2lkdGggOiBsaW5lV2lkdGggKiAxLjc7XG4gICAgICAgICAgICBjb250ZXh0LmxpbmVDYXAgPSAncm91bmQnO1xuICAgICAgICAgICAgY29udGV4dC5zdHJva2VTdHlsZSA9IHBhaW50Q29sb3I7XG5cbiAgICAgICAgICAgIGNvbnN0IHNjcmVlblBvc2l0aW9uID0gdGhpcy5ldmVudFBvc2l0aW9uKGV2ZW50KTtcbiAgICAgICAgICAgIGNvbnRleHQubGluZVRvKFxuICAgICAgICAgICAgICBzY3JlZW5Qb3NpdGlvbi54IC0gY2FudmFzT2Zmc2V0WCxcbiAgICAgICAgICAgICAgc2NyZWVuUG9zaXRpb24ueSAtIGNhbnZhc09mZnNldFlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb250ZXh0LnN0cm9rZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9XG4gICk7XG5cbiAgcmVhZG9ubHkgc3RhcnRTa2V0Y2ggPSB0aGlzLmVmZmVjdChcbiAgICAoZXZlbnQkOiBPYnNlcnZhYmxlPE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50PikgPT4ge1xuICAgICAgcmV0dXJuIGV2ZW50JC5waXBlKFxuICAgICAgICB0YXAoZXZlbnQgPT4ge1xuICAgICAgICAgIGNvbnN0IHNjcmVlblBvc2l0aW9uID0gdGhpcy5ldmVudFBvc2l0aW9uKFxuICAgICAgICAgICAgZXZlbnQgYXMgdW5rbm93biBhcyBNb3VzZUV2ZW50IHwgVG91Y2hFdmVudFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICB0aGlzLnVwZGF0ZUlzU2tldGNoaW5nKHRydWUpO1xuICAgICAgICAgIHRoaXMudXBkYXRlU3RhcnRYKHNjcmVlblBvc2l0aW9uLngpO1xuICAgICAgICAgIHRoaXMudXBkYXRlU3RhcnRZKHNjcmVlblBvc2l0aW9uLnkpO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICk7XG5cbiAgcmVhZG9ubHkgc3RvcFNrZXRjaCA9IHRoaXMuZWZmZWN0KFxuICAgIChldmVudCQ6IE9ic2VydmFibGU8TW91c2VFdmVudCB8IFRvdWNoRXZlbnQ+KSA9PiB7XG4gICAgICByZXR1cm4gY29tYmluZUxhdGVzdChbZXZlbnQkLCB0aGlzLmNvbnRleHQkXSkucGlwZShcbiAgICAgICAgdGFwKChbLCBjb250ZXh0XSkgPT4ge1xuICAgICAgICAgIHRoaXMudXBkYXRlSXNTa2V0Y2hpbmcoZmFsc2UpO1xuXG4gICAgICAgICAgaWYgKGNvbnRleHQgPT09IG51bGwpIHJldHVybjtcbiAgICAgICAgICBjb250ZXh0LnN0cm9rZSgpO1xuICAgICAgICAgIGNvbnRleHQuYmVnaW5QYXRoKCk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgKTtcblxuICByZWFkb25seSB1cGRhdGVDYW52YXNTaXplID0gdGhpcy5lZmZlY3QoXG4gICAgKGFyZ3MkOiBPYnNlcnZhYmxlPFtudW1iZXIsIG51bWJlcl0+KSA9PiB7XG4gICAgICByZXR1cm4gYXJncyQucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKChbd2lkdGgsIGhlaWdodF0pID0+IHtcbiAgICAgICAgICByZXR1cm4gY29tYmluZUxhdGVzdChbXG4gICAgICAgICAgICB0aGlzLmNhbnZhcyQsXG4gICAgICAgICAgICB0aGlzLmNvbnRleHQkLFxuICAgICAgICAgICAgb2Yod2lkdGgpLFxuICAgICAgICAgICAgb2YoaGVpZ2h0KSxcbiAgICAgICAgICBdKTtcbiAgICAgICAgfSksXG4gICAgICAgIGZpbHRlcihcbiAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnMgKi9cbiAgICAgICAgICAoW2NhbnZhcywgY29udGV4dCwgd2lkdGgsIGhlaWdodF0pID0+XG4gICAgICAgICAgICBjYW52YXMgIT09IG51bGwgJiYgY29udGV4dCAhPT0gbnVsbFxuICAgICAgICApLFxuICAgICAgICB0YXAoKFtjYW52YXMsIGNvbnRleHQsIHdpZHRoLCBoZWlnaHRdKSA9PiB7XG4gICAgICAgICAgLy8gUmVzaXppbmcgdGhlIGNhbnZhcyB3aWxsIGNsZWFyIGl0cyBjb250ZW50cywgc28gc3RvcmUgdGhlIGN1cnJlbnRcbiAgICAgICAgICAvLyBjYW52YXMgY29udGVudHMgYmVmb3JlIHJlc2l6aW5nIHNvIHRoZXkgY2FuIGJlIHJlc3RvcmVkIGFmdGVyLlxuICAgICAgICAgIGNvbnN0IGN1cnJlbnRDYW52YXNDb250ZW50ID0gY29udGV4dCEuZ2V0SW1hZ2VEYXRhKFxuICAgICAgICAgICAgMCxcbiAgICAgICAgICAgIDAsXG4gICAgICAgICAgICBjYW52YXMhLndpZHRoLFxuICAgICAgICAgICAgY2FudmFzIS5oZWlnaHRcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gTm93IHJlc2l6ZSB0aGUgY2FudmFzXG4gICAgICAgICAgY2FudmFzIS53aWR0aCA9IHdpZHRoO1xuICAgICAgICAgIGNhbnZhcyEuaGVpZ2h0ID0gaGVpZ2h0O1xuXG4gICAgICAgICAgLy8gUmVhcHBseSBzYXZlZCBjb250ZW50cy9cbiAgICAgICAgICBjb250ZXh0IS5wdXRJbWFnZURhdGEoY3VycmVudENhbnZhc0NvbnRlbnQsIDAsIDApO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICk7XG5cbiAgLyoqXG4gICAqICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tK1xuICAgKiBDTEFTUyBNRVRIT0RTXG4gICAqICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tK1xuICAgKi9cblxuICAvKipcbiAgICogVGFrZXMgYSBtb3VzZW1vdmUgb3IgdG91Y2htb3ZlIGV2ZW50IGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcG9zaXRpb25cbiAgICogb24gdGhlIHNjcmVlbiB3aGVyZSB0aGUgZXZlbnQgb2NjdXJyZWQuXG4gICAqL1xuICBwcml2YXRlIGV2ZW50UG9zaXRpb24oZXZlbnQ6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KToge1xuICAgIHg6IG51bWJlcjtcbiAgICB5OiBudW1iZXI7XG4gIH0ge1xuICAgIGNvbnN0IGlzVG91Y2hFdmVudCA9IGV2ZW50IGluc3RhbmNlb2YgVG91Y2hFdmVudDtcblxuICAgIGNvbnN0IG5ld1ggPSBpc1RvdWNoRXZlbnRcbiAgICAgID8gKGV2ZW50IGFzIFRvdWNoRXZlbnQpLnRvdWNoZXNbMF0ucGFnZVhcbiAgICAgIDogKGV2ZW50IGFzIE1vdXNlRXZlbnQpLmNsaWVudFg7XG4gICAgY29uc3QgbmV3WSA9IGlzVG91Y2hFdmVudFxuICAgICAgPyAoZXZlbnQgYXMgVG91Y2hFdmVudCkudG91Y2hlc1swXS5wYWdlWVxuICAgICAgOiAoZXZlbnQgYXMgTW91c2VFdmVudCkuY2xpZW50WTtcblxuICAgIHJldHVybiB7XG4gICAgICB4OiBuZXdYLFxuICAgICAgeTogbmV3WSxcbiAgICB9O1xuICB9XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgc3VwZXIoSU5JVElBTF9TVEFURSk7XG4gIH1cbn1cbiJdfQ==
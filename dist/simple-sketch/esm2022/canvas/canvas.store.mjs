import { Injectable, inject } from '@angular/core';
import { ComponentStore } from '@ngrx/component-store';
import { BehaviorSubject, combineLatest, debounceTime, filter, fromEvent, of, switchMap, takeUntil, tap, } from 'rxjs';
import { WINDOW } from '../injection-tokens';
import * as i0 from "@angular/core";
export var Mode;
(function (Mode) {
    Mode["ERASE"] = "erase";
    Mode["SKETCH"] = "sketch";
})(Mode || (Mode = {}));
const INITIAL_STATE = {
    backgroundColor: '#000000',
    canvasOffsetX: 0,
    canvasOffsetY: 0,
    isSketching: false,
    lineWidth: 5,
    mode: Mode.SKETCH,
    paintColor: '#ffffff',
    startX: 0,
    startY: 0,
};
export class SimpleSketchCanvasStore extends ComponentStore {
    canvas$ = new BehaviorSubject(null);
    context$ = new BehaviorSubject(null);
    window = inject(WINDOW);
    /**
     * +-------------------------------------------+
     * SELECTORS
     * +-------------------------------------------+
     */
    backgroundColor$ = this.select(state => state.backgroundColor);
    paintColor$ = this.select(state => state.paintColor);
    canvasOffsetX$ = this.select(state => state.canvasOffsetX);
    canvasOffsetY$ = this.select(state => state.canvasOffsetY);
    isSketching$ = this.select(state => state.isSketching);
    lineWidth$ = this.select(state => state.lineWidth);
    mode$ = this.select(state => state.mode);
    /**
     * +-------------------------------------------+
     * UPDATERS
     * +-------------------------------------------+
     */
    updateBackGroundColor = this.updater((state, newBackgroundColor) => ({
        ...state,
        backgroundColor: newBackgroundColor,
    }));
    updateIsSketching = this.updater((state, isSketching) => ({
        ...state,
        isSketching,
    }));
    updateCanvasOffsetX = this.updater((state, newCanvasOffsetX) => ({
        ...state,
        canvasOffsetX: newCanvasOffsetX,
    }));
    updateCanvasOffsetY = this.updater((state, newCanvasOffsetY) => ({
        ...state,
        canvasOffsetY: newCanvasOffsetY,
    }));
    updatePaintColor = this.updater((state, newPaintColor) => ({
        ...state,
        paintColor: newPaintColor,
    }));
    updateMode = this.updater((state, newMode) => ({
        ...state,
        mode: newMode,
    }));
    updateStartX = this.updater((state, newStartX) => ({
        ...state,
        startX: newStartX,
    }));
    updateStartY = this.updater((state, newStartY) => ({
        ...state,
        startY: newStartY,
    }));
    /**
     * +-------------------------------------------+
     * EFFECTS
     * +-------------------------------------------+
     */
    applyBackgroundColor = this.effect(() => {
        return combineLatest([this.backgroundColor$, this.canvas$]).pipe(tap(([color, canvas]) => {
            if (canvas) {
                canvas.style.backgroundColor = color;
            }
        }));
    });
    clearCanvas = this.effect(trigger$ => combineLatest([trigger$, this.context$, this.canvas$]).pipe(tap(([, context, canvas]) => {
        if (context && canvas) {
            context.clearRect(0, 0, canvas.width, canvas.height);
        }
    })));
    init = this.effect((data$) => {
        return data$.pipe(tap(([canvas, backgroundColor, paintColor]) => {
            const context = canvas.getContext('2d');
            // Initialize canvas & context properties using the supplied `canvas`.
            this.canvas$.next(canvas);
            this.context$.next(context);
            // Canvases must have their width and height pixel values set. The
            // canvas' _parent (`.canvas-wrapper`), flexes to grow to the
            // available space. Set the actual canvas element to the pixel
            // dimensions available inside its parent.
            const canvasWrapper = canvas.parentElement;
            const canvasWrapperSize = this.getElementSizeMinusPadding(canvasWrapper);
            this.updateCanvasSize([
                canvasWrapperSize.width,
                canvasWrapperSize.height,
            ]);
            // Set some prperties in component state.
            this.updateCanvasOffsetX(canvas.offsetLeft);
            this.updateCanvasOffsetY(canvas.offsetTop);
            this.updateBackGroundColor(backgroundColor);
            this.updatePaintColor(paintColor);
            this.applyBackgroundColor();
            // Subscribe to resize events so the canvas' pixel dimensions redraw
            // using the values from the post-resize available space.
            fromEvent(this.window, 'resize')
                .pipe(takeUntil(this.destroy$), debounceTime(75))
                .subscribe(() => {
                const canvasWrapperSize = this.getElementSizeMinusPadding(canvasWrapper);
                this.updateCanvasSize([
                    canvasWrapperSize.width,
                    canvasWrapperSize.height,
                ]);
            });
        }));
    });
    sketch = this.effect((event$) => {
        return combineLatest([
            event$,
            this.context$,
            this.isSketching$,
            this.lineWidth$,
            this.canvasOffsetX$,
            this.canvasOffsetY$,
            this.paintColor$,
            this.mode$,
        ]).pipe(tap(([event, context, isSketching, lineWidth, canvasOffsetX, canvasOffsetY, paintColor, mode,]) => {
            if (!isSketching || context === null)
                return;
            context.globalCompositeOperation =
                mode === Mode.SKETCH ? 'source-over' : 'destination-out';
            // Make the eraser larger than the finer point brush used for
            // sketching.
            const eraserLineWidth = lineWidth * 1.7;
            context.lineWidth =
                mode === Mode.SKETCH ? lineWidth : eraserLineWidth;
            context.lineCap = 'round';
            context.strokeStyle = paintColor;
            const screenPosition = this.eventPosition(event);
            context.lineTo(screenPosition.x - canvasOffsetX, screenPosition.y - canvasOffsetY);
            context.stroke();
        }));
    });
    startSketch = this.effect((event$) => {
        return combineLatest([event$, this.context$]).pipe(tap(([event, context]) => {
            const screenPosition = this.eventPosition(event);
            this.updateIsSketching(true);
            this.updateStartX(screenPosition.x);
            this.updateStartY(screenPosition.y);
        }));
    });
    stopSketch = this.effect((event$) => {
        return combineLatest([event$, this.context$]).pipe(tap(([, context]) => {
            this.updateIsSketching(false);
            context?.stroke();
            context?.beginPath();
        }));
    });
    updateCanvasSize = this.effect((args$) => {
        return args$.pipe(switchMap(([width, height]) => {
            return combineLatest([
                this.canvas$,
                this.context$,
                of(width),
                of(height),
            ]);
        }), filter(
        /* eslint-disable @typescript-eslint/no-unused-vars */
        ([canvas, context, width, height]) => canvas !== null && context !== null), tap(([canvas, context, width, height]) => {
            // Resizing the canvas will clear its contents, so store the current
            // canvas contents before resizing so they can be restored after.
            const currentCanvasContent = context.getImageData(0, 0, canvas.width, canvas.height);
            // Now resize the canvas
            canvas.width = width;
            canvas.height = height;
            // Reapply saved contents/
            context.putImageData(currentCanvasContent, 0, 0);
        }));
    });
    /**
     * +-------------------------------------------+
     * CLASS METHODS
     * +-------------------------------------------+
     */
    /**
     * Takes a mousemove or touchmove event and return the corresponding position
     * on the screen where the event occurred.
     */
    eventPosition(event) {
        const isTouchEvent = event instanceof TouchEvent;
        const newX = isTouchEvent
            ? event.touches[0].pageX
            : event.clientX;
        const newY = isTouchEvent
            ? event.touches[0].pageY
            : event.clientY;
        return {
            x: newX,
            y: newY,
        };
    }
    getElementSizeMinusPadding(element) {
        const computedStyle = this.window.getComputedStyle(element);
        const width = element.clientWidth -
            (parseFloat(computedStyle.paddingLeft) +
                parseFloat(computedStyle.paddingRight));
        const height = element.clientHeight -
            (parseFloat(computedStyle.paddingTop) +
                parseFloat(computedStyle.paddingBottom));
        return { width, height };
    }
    constructor() {
        super(INITIAL_STATE);
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: SimpleSketchCanvasStore, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
    static ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: SimpleSketchCanvasStore });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: SimpleSketchCanvasStore, decorators: [{
            type: Injectable
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLnN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NpbXBsZS1za2V0Y2gvY2FudmFzL2NhbnZhcy5zdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFDckQsT0FBTyxFQUNMLGVBQWUsRUFFZixhQUFhLEVBQ2IsWUFBWSxFQUNaLE1BQU0sRUFDTixTQUFTLEVBQ1QsRUFBRSxFQUNGLFNBQVMsRUFDVCxTQUFTLEVBQ1QsR0FBRyxHQUNKLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLHFCQUFxQixDQUFDOztBQUUzQyxNQUFNLENBQU4sSUFBWSxJQUdYO0FBSEQsV0FBWSxJQUFJO0lBQ2QsdUJBQWUsQ0FBQTtJQUNmLHlCQUFpQixDQUFBO0FBQ25CLENBQUMsRUFIVyxJQUFJLEtBQUosSUFBSSxRQUdmO0FBY0QsTUFBTSxhQUFhLEdBQTRCO0lBQzdDLGVBQWUsRUFBRSxTQUFTO0lBQzFCLGFBQWEsRUFBRSxDQUFDO0lBQ2hCLGFBQWEsRUFBRSxDQUFDO0lBQ2hCLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLFNBQVMsRUFBRSxDQUFDO0lBQ1osSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNO0lBQ2pCLFVBQVUsRUFBRSxTQUFTO0lBQ3JCLE1BQU0sRUFBRSxDQUFDO0lBQ1QsTUFBTSxFQUFFLENBQUM7Q0FDVixDQUFDO0FBUUYsTUFBTSxPQUFPLHVCQUF3QixTQUFRLGNBQXVDO0lBQzFFLE9BQU8sR0FBRyxJQUFJLGVBQWUsQ0FBMkIsSUFBSSxDQUFDLENBQUM7SUFDOUQsUUFBUSxHQUFHLElBQUksZUFBZSxDQUFrQyxJQUFJLENBQUMsQ0FBQztJQUN0RSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FB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QUFDLEtBQUs7WUFDeEMsQ0FBQyxDQUFFLEtBQW9CLENBQUMsT0FBTyxDQUFDO1FBQ2xDLE1BQU0sSUFBSSxHQUFHLFlBQVk7WUFDdkIsQ0FBQyxDQUFFLEtBQW9CLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUs7WUFDeEMsQ0FBQyxDQUFFLEtBQW9CLENBQUMsT0FBTyxDQUFDO1FBRWxDLE9BQU87WUFDTCxDQUFDLEVBQUUsSUFBSTtZQUNQLENBQUMsRUFBRSxJQUFJO1NBQ1IsQ0FBQztJQUNKLENBQUM7SUFFTywwQkFBMEIsQ0FBQyxPQUFvQjtRQUNyRCxNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzVELE1BQU0sS0FBSyxHQUNULE9BQU8sQ0FBQyxXQUFXO1lBQ25CLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUM7Z0JBQ3BDLFVBQVUsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztRQUM1QyxNQUFNLE1BQU0sR0FDVixPQUFPLENBQUMsWUFBWTtZQUNwQixDQUFDLFVBQVUsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDO2dCQUNuQyxVQUFVLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUM7UUFDN0MsT0FBTyxFQUFDLEtBQUssRUFBRSxNQUFNLEVBQVMsQ0FBQztJQUNqQyxDQUFDO0lBRUQ7UUFDRSxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDdkIsQ0FBQzt1R0E3VFUsdUJBQXVCOzJHQUF2Qix1QkFBdUI7OzJGQUF2Qix1QkFBdUI7a0JBRG5DLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0luamVjdGFibGUsIGluamVjdH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge0NvbXBvbmVudFN0b3JlfSBmcm9tICdAbmdyeC9jb21wb25lbnQtc3RvcmUnO1xuaW1wb3J0IHtcbiAgQmVoYXZpb3JTdWJqZWN0LFxuICBPYnNlcnZhYmxlLFxuICBjb21iaW5lTGF0ZXN0LFxuICBkZWJvdW5jZVRpbWUsXG4gIGZpbHRlcixcbiAgZnJvbUV2ZW50LFxuICBvZixcbiAgc3dpdGNoTWFwLFxuICB0YWtlVW50aWwsXG4gIHRhcCxcbn0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1dJTkRPV30gZnJvbSAnLi4vaW5qZWN0aW9uLXRva2Vucyc7XG5cbmV4cG9ydCBlbnVtIE1vZGUge1xuICBFUkFTRSA9ICdlcmFzZScsXG4gIFNLRVRDSCA9ICdza2V0Y2gnLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFNpbXBsZVNrZXRjaENhbnZhc1N0YXRlIHtcbiAgYmFja2dyb3VuZENvbG9yOiBzdHJpbmc7XG4gIGNhbnZhc09mZnNldFg6IG51bWJlcjtcbiAgY2FudmFzT2Zmc2V0WTogbnVtYmVyO1xuICBpc1NrZXRjaGluZzogYm9vbGVhbjtcbiAgbGluZVdpZHRoOiBudW1iZXI7XG4gIG1vZGU6IE1vZGU7XG4gIHBhaW50Q29sb3I6IHN0cmluZztcbiAgc3RhcnRYOiBudW1iZXI7XG4gIHN0YXJ0WTogbnVtYmVyO1xufVxuXG5jb25zdCBJTklUSUFMX1NUQVRFOiBTaW1wbGVTa2V0Y2hDYW52YXNTdGF0ZSA9IHtcbiAgYmFja2dyb3VuZENvbG9yOiAnIzAwMDAwMCcsXG4gIGNhbnZhc09mZnNldFg6IDAsXG4gIGNhbnZhc09mZnNldFk6IDAsXG4gIGlzU2tldGNoaW5nOiBmYWxzZSxcbiAgbGluZVdpZHRoOiA1LFxuICBtb2RlOiBNb2RlLlNLRVRDSCxcbiAgcGFpbnRDb2xvcjogJyNmZmZmZmYnLFxuICBzdGFydFg6IDAsXG4gIHN0YXJ0WTogMCxcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2l6ZSB7XG4gIGhlaWdodDogbnVtYmVyO1xuICB3aWR0aDogbnVtYmVyO1xufVxuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgU2ltcGxlU2tldGNoQ2FudmFzU3RvcmUgZXh0ZW5kcyBDb21wb25lbnRTdG9yZTxTaW1wbGVTa2V0Y2hDYW52YXNTdGF0ZT4ge1xuICBwcml2YXRlIGNhbnZhcyQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEhUTUxDYW52YXNFbGVtZW50IHwgbnVsbD4obnVsbCk7XG4gIHByaXZhdGUgY29udGV4dCQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCB8IG51bGw+KG51bGwpO1xuICBwcml2YXRlIHdpbmRvdyA9IGluamVjdChXSU5ET1cpO1xuXG4gIC8qKlxuICAgKiArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLStcbiAgICogU0VMRUNUT1JTXG4gICAqICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tK1xuICAgKi9cbiAgcmVhZG9ubHkgYmFja2dyb3VuZENvbG9yJDogT2JzZXJ2YWJsZTxzdHJpbmc+ID0gdGhpcy5zZWxlY3QoXG4gICAgc3RhdGUgPT4gc3RhdGUuYmFja2dyb3VuZENvbG9yXG4gICk7XG5cbiAgcmVhZG9ubHkgcGFpbnRDb2xvciQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMuc2VsZWN0KFxuICAgIHN0YXRlID0+IHN0YXRlLnBhaW50Q29sb3JcbiAgKTtcblxuICByZWFkb25seSBjYW52YXNPZmZzZXRYJDogT2JzZXJ2YWJsZTxudW1iZXI+ID0gdGhpcy5zZWxlY3QoXG4gICAgc3RhdGUgPT4gc3RhdGUuY2FudmFzT2Zmc2V0WFxuICApO1xuXG4gIHJlYWRvbmx5IGNhbnZhc09mZnNldFkkOiBPYnNlcnZhYmxlPG51bWJlcj4gPSB0aGlzLnNlbGVjdChcbiAgICBzdGF0ZSA9PiBzdGF0ZS5jYW52YXNPZmZzZXRZXG4gICk7XG5cbiAgcmVhZG9ubHkgaXNTa2V0Y2hpbmckOiBPYnNlcnZhYmxlPGJvb2xlYW4+ID0gdGhpcy5zZWxlY3QoXG4gICAgc3RhdGUgPT4gc3RhdGUuaXNTa2V0Y2hpbmdcbiAgKTtcblxuICByZWFkb25seSBsaW5lV2lkdGgkOiBPYnNlcnZhYmxlPG51bWJlcj4gPSB0aGlzLnNlbGVjdChcbiAgICBzdGF0ZSA9PiBzdGF0ZS5saW5lV2lkdGhcbiAgKTtcblxuICByZWFkb25seSBtb2RlJDogT2JzZXJ2YWJsZTxNb2RlPiA9IHRoaXMuc2VsZWN0KHN0YXRlID0+IHN0YXRlLm1vZGUpO1xuXG4gIC8qKlxuICAgKiArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLStcbiAgICogVVBEQVRFUlNcbiAgICogKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rXG4gICAqL1xuICByZWFkb25seSB1cGRhdGVCYWNrR3JvdW5kQ29sb3IgPSB0aGlzLnVwZGF0ZXIoXG4gICAgKHN0YXRlLCBuZXdCYWNrZ3JvdW5kQ29sb3I6IHN0cmluZykgPT4gKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgYmFja2dyb3VuZENvbG9yOiBuZXdCYWNrZ3JvdW5kQ29sb3IsXG4gICAgfSlcbiAgKTtcblxuICByZWFkb25seSB1cGRhdGVJc1NrZXRjaGluZyA9IHRoaXMudXBkYXRlcigoc3RhdGUsIGlzU2tldGNoaW5nOiBib29sZWFuKSA9PiAoe1xuICAgIC4uLnN0YXRlLFxuICAgIGlzU2tldGNoaW5nLFxuICB9KSk7XG5cbiAgcmVhZG9ubHkgdXBkYXRlQ2FudmFzT2Zmc2V0WCA9IHRoaXMudXBkYXRlcihcbiAgICAoc3RhdGUsIG5ld0NhbnZhc09mZnNldFg6IG51bWJlcikgPT4gKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgY2FudmFzT2Zmc2V0WDogbmV3Q2FudmFzT2Zmc2V0WCxcbiAgICB9KVxuICApO1xuXG4gIHJlYWRvbmx5IHVwZGF0ZUNhbnZhc09mZnNldFkgPSB0aGlzLnVwZGF0ZXIoXG4gICAgKHN0YXRlLCBuZXdDYW52YXNPZmZzZXRZOiBudW1iZXIpID0+ICh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGNhbnZhc09mZnNldFk6IG5ld0NhbnZhc09mZnNldFksXG4gICAgfSlcbiAgKTtcblxuICByZWFkb25seSB1cGRhdGVQYWludENvbG9yID0gdGhpcy51cGRhdGVyKChzdGF0ZSwgbmV3UGFpbnRDb2xvcjogc3RyaW5nKSA9PiAoe1xuICAgIC4uLnN0YXRlLFxuICAgIHBhaW50Q29sb3I6IG5ld1BhaW50Q29sb3IsXG4gIH0pKTtcblxuICByZWFkb25seSB1cGRhdGVNb2RlID0gdGhpcy51cGRhdGVyKChzdGF0ZSwgbmV3TW9kZTogTW9kZSkgPT4gKHtcbiAgICAuLi5zdGF0ZSxcbiAgICBtb2RlOiBuZXdNb2RlLFxuICB9KSk7XG5cbiAgcmVhZG9ubHkgdXBkYXRlU3RhcnRYID0gdGhpcy51cGRhdGVyKChzdGF0ZSwgbmV3U3RhcnRYOiBudW1iZXIpID0+ICh7XG4gICAgLi4uc3RhdGUsXG4gICAgc3RhcnRYOiBuZXdTdGFydFgsXG4gIH0pKTtcblxuICByZWFkb25seSB1cGRhdGVTdGFydFkgPSB0aGlzLnVwZGF0ZXIoKHN0YXRlLCBuZXdTdGFydFk6IG51bWJlcikgPT4gKHtcbiAgICAuLi5zdGF0ZSxcbiAgICBzdGFydFk6IG5ld1N0YXJ0WSxcbiAgfSkpO1xuXG4gIC8qKlxuICAgKiArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLStcbiAgICogRUZGRUNUU1xuICAgKiArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLStcbiAgICovXG4gIHJlYWRvbmx5IGFwcGx5QmFja2dyb3VuZENvbG9yID0gdGhpcy5lZmZlY3QoKCkgPT4ge1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFt0aGlzLmJhY2tncm91bmRDb2xvciQsIHRoaXMuY2FudmFzJF0pLnBpcGUoXG4gICAgICB0YXAoKFtjb2xvciwgY2FudmFzXSkgPT4ge1xuICAgICAgICBpZiAoY2FudmFzKSB7XG4gICAgICAgICAgY2FudmFzLnN0eWxlLmJhY2tncm91bmRDb2xvciA9IGNvbG9yO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG4gIH0pO1xuXG4gIHJlYWRvbmx5IGNsZWFyQ2FudmFzID0gdGhpcy5lZmZlY3QodHJpZ2dlciQgPT5cbiAgICBjb21iaW5lTGF0ZXN0KFt0cmlnZ2VyJCwgdGhpcy5jb250ZXh0JCwgdGhpcy5jYW52YXMkXSkucGlwZShcbiAgICAgIHRhcCgoWywgY29udGV4dCwgY2FudmFzXSkgPT4ge1xuICAgICAgICBpZiAoY29udGV4dCAmJiBjYW52YXMpIHtcbiAgICAgICAgICBjb250ZXh0LmNsZWFyUmVjdCgwLCAwLCBjYW52YXMud2lkdGgsIGNhbnZhcy5oZWlnaHQpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgIClcbiAgKTtcblxuICByZWFkb25seSBpbml0ID0gdGhpcy5lZmZlY3QoXG4gICAgKGRhdGEkOiBPYnNlcnZhYmxlPFtIVE1MQ2FudmFzRWxlbWVudCwgc3RyaW5nLCBzdHJpbmddPikgPT4ge1xuICAgICAgcmV0dXJuIGRhdGEkLnBpcGUoXG4gICAgICAgIHRhcCgoW2NhbnZhcywgYmFja2dyb3VuZENvbG9yLCBwYWludENvbG9yXSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKTtcbiAgICAgICAgICAvLyBJbml0aWFsaXplIGNhbnZhcyAmIGNvbnRleHQgcHJvcGVydGllcyB1c2luZyB0aGUgc3VwcGxpZWQgYGNhbnZhc2AuXG4gICAgICAgICAgdGhpcy5jYW52YXMkLm5leHQoY2FudmFzKTtcbiAgICAgICAgICB0aGlzLmNvbnRleHQkLm5leHQoY29udGV4dCk7XG5cbiAgICAgICAgICAvLyBDYW52YXNlcyBtdXN0IGhhdmUgdGhlaXIgd2lkdGggYW5kIGhlaWdodCBwaXhlbCB2YWx1ZXMgc2V0LiBUaGVcbiAgICAgICAgICAvLyBjYW52YXMnIF9wYXJlbnQgKGAuY2FudmFzLXdyYXBwZXJgKSwgZmxleGVzIHRvIGdyb3cgdG8gdGhlXG4gICAgICAgICAgLy8gYXZhaWxhYmxlIHNwYWNlLiBTZXQgdGhlIGFjdHVhbCBjYW52YXMgZWxlbWVudCB0byB0aGUgcGl4ZWxcbiAgICAgICAgICAvLyBkaW1lbnNpb25zIGF2YWlsYWJsZSBpbnNpZGUgaXRzIHBhcmVudC5cbiAgICAgICAgICBjb25zdCBjYW52YXNXcmFwcGVyID0gY2FudmFzLnBhcmVudEVsZW1lbnQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgICAgY29uc3QgY2FudmFzV3JhcHBlclNpemUgPVxuICAgICAgICAgICAgdGhpcy5nZXRFbGVtZW50U2l6ZU1pbnVzUGFkZGluZyhjYW52YXNXcmFwcGVyKTtcblxuICAgICAgICAgIHRoaXMudXBkYXRlQ2FudmFzU2l6ZShbXG4gICAgICAgICAgICBjYW52YXNXcmFwcGVyU2l6ZS53aWR0aCxcbiAgICAgICAgICAgIGNhbnZhc1dyYXBwZXJTaXplLmhlaWdodCxcbiAgICAgICAgICBdKTtcblxuICAgICAgICAgIC8vIFNldCBzb21lIHBycGVydGllcyBpbiBjb21wb25lbnQgc3RhdGUuXG4gICAgICAgICAgdGhpcy51cGRhdGVDYW52YXNPZmZzZXRYKGNhbnZhcy5vZmZzZXRMZWZ0KTtcbiAgICAgICAgICB0aGlzLnVwZGF0ZUNhbnZhc09mZnNldFkoY2FudmFzLm9mZnNldFRvcCk7XG4gICAgICAgICAgdGhpcy51cGRhdGVCYWNrR3JvdW5kQ29sb3IoYmFja2dyb3VuZENvbG9yKTtcbiAgICAgICAgICB0aGlzLnVwZGF0ZVBhaW50Q29sb3IocGFpbnRDb2xvcik7XG5cbiAgICAgICAgICB0aGlzLmFwcGx5QmFja2dyb3VuZENvbG9yKCk7XG5cbiAgICAgICAgICAvLyBTdWJzY3JpYmUgdG8gcmVzaXplIGV2ZW50cyBzbyB0aGUgY2FudmFzJyBwaXhlbCBkaW1lbnNpb25zIHJlZHJhd1xuICAgICAgICAgIC8vIHVzaW5nIHRoZSB2YWx1ZXMgZnJvbSB0aGUgcG9zdC1yZXNpemUgYXZhaWxhYmxlIHNwYWNlLlxuICAgICAgICAgIGZyb21FdmVudCh0aGlzLndpbmRvdywgJ3Jlc2l6ZScpXG4gICAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95JCksIGRlYm91bmNlVGltZSg3NSkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgY2FudmFzV3JhcHBlclNpemUgPVxuICAgICAgICAgICAgICAgIHRoaXMuZ2V0RWxlbWVudFNpemVNaW51c1BhZGRpbmcoY2FudmFzV3JhcHBlcik7XG5cbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVDYW52YXNTaXplKFtcbiAgICAgICAgICAgICAgICBjYW52YXNXcmFwcGVyU2l6ZS53aWR0aCxcbiAgICAgICAgICAgICAgICBjYW52YXNXcmFwcGVyU2l6ZS5oZWlnaHQsXG4gICAgICAgICAgICAgIF0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgKTtcblxuICByZWFkb25seSBza2V0Y2ggPSB0aGlzLmVmZmVjdChcbiAgICAoZXZlbnQkOiBPYnNlcnZhYmxlPE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50PikgPT4ge1xuICAgICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgICBldmVudCQsXG4gICAgICAgIHRoaXMuY29udGV4dCQsXG4gICAgICAgIHRoaXMuaXNTa2V0Y2hpbmckLFxuICAgICAgICB0aGlzLmxpbmVXaWR0aCQsXG4gICAgICAgIHRoaXMuY2FudmFzT2Zmc2V0WCQsXG4gICAgICAgIHRoaXMuY2FudmFzT2Zmc2V0WSQsXG4gICAgICAgIHRoaXMucGFpbnRDb2xvciQsXG4gICAgICAgIHRoaXMubW9kZSQsXG4gICAgICBdKS5waXBlKFxuICAgICAgICB0YXAoXG4gICAgICAgICAgKFtcbiAgICAgICAgICAgIGV2ZW50LFxuICAgICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICAgIGlzU2tldGNoaW5nLFxuICAgICAgICAgICAgbGluZVdpZHRoLFxuICAgICAgICAgICAgY2FudmFzT2Zmc2V0WCxcbiAgICAgICAgICAgIGNhbnZhc09mZnNldFksXG4gICAgICAgICAgICBwYWludENvbG9yLFxuICAgICAgICAgICAgbW9kZSxcbiAgICAgICAgICBdKSA9PiB7XG4gICAgICAgICAgICBpZiAoIWlzU2tldGNoaW5nIHx8IGNvbnRleHQgPT09IG51bGwpIHJldHVybjtcbiAgICAgICAgICAgIGNvbnRleHQuZ2xvYmFsQ29tcG9zaXRlT3BlcmF0aW9uID1cbiAgICAgICAgICAgICAgbW9kZSA9PT0gTW9kZS5TS0VUQ0ggPyAnc291cmNlLW92ZXInIDogJ2Rlc3RpbmF0aW9uLW91dCc7XG4gICAgICAgICAgICAvLyBNYWtlIHRoZSBlcmFzZXIgbGFyZ2VyIHRoYW4gdGhlIGZpbmVyIHBvaW50IGJydXNoIHVzZWQgZm9yXG4gICAgICAgICAgICAvLyBza2V0Y2hpbmcuXG4gICAgICAgICAgICBjb25zdCBlcmFzZXJMaW5lV2lkdGggPSBsaW5lV2lkdGggKiAxLjc7XG4gICAgICAgICAgICBjb250ZXh0LmxpbmVXaWR0aCA9XG4gICAgICAgICAgICAgIG1vZGUgPT09IE1vZGUuU0tFVENIID8gbGluZVdpZHRoIDogZXJhc2VyTGluZVdpZHRoO1xuICAgICAgICAgICAgY29udGV4dC5saW5lQ2FwID0gJ3JvdW5kJztcbiAgICAgICAgICAgIGNvbnRleHQuc3Ryb2tlU3R5bGUgPSBwYWludENvbG9yO1xuXG4gICAgICAgICAgICBjb25zdCBzY3JlZW5Qb3NpdGlvbiA9IHRoaXMuZXZlbnRQb3NpdGlvbihldmVudCk7XG5cbiAgICAgICAgICAgIGNvbnRleHQubGluZVRvKFxuICAgICAgICAgICAgICBzY3JlZW5Qb3NpdGlvbi54IC0gY2FudmFzT2Zmc2V0WCxcbiAgICAgICAgICAgICAgc2NyZWVuUG9zaXRpb24ueSAtIGNhbnZhc09mZnNldFlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBjb250ZXh0LnN0cm9rZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgKVxuICAgICAgKTtcbiAgICB9XG4gICk7XG5cbiAgcmVhZG9ubHkgc3RhcnRTa2V0Y2ggPSB0aGlzLmVmZmVjdChcbiAgICAoZXZlbnQkOiBPYnNlcnZhYmxlPE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50PikgPT4ge1xuICAgICAgcmV0dXJuIGNvbWJpbmVMYXRlc3QoW2V2ZW50JCwgdGhpcy5jb250ZXh0JF0pLnBpcGUoXG4gICAgICAgIHRhcCgoW2V2ZW50LCBjb250ZXh0XSkgPT4ge1xuICAgICAgICAgIGNvbnN0IHNjcmVlblBvc2l0aW9uID0gdGhpcy5ldmVudFBvc2l0aW9uKFxuICAgICAgICAgICAgZXZlbnQgYXMgdW5rbm93biBhcyBNb3VzZUV2ZW50IHwgVG91Y2hFdmVudFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICB0aGlzLnVwZGF0ZUlzU2tldGNoaW5nKHRydWUpO1xuICAgICAgICAgIHRoaXMudXBkYXRlU3RhcnRYKHNjcmVlblBvc2l0aW9uLngpO1xuICAgICAgICAgIHRoaXMudXBkYXRlU3RhcnRZKHNjcmVlblBvc2l0aW9uLnkpO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICk7XG5cbiAgcmVhZG9ubHkgc3RvcFNrZXRjaCA9IHRoaXMuZWZmZWN0KFxuICAgIChldmVudCQ6IE9ic2VydmFibGU8TW91c2VFdmVudCB8IFRvdWNoRXZlbnQ+KSA9PiB7XG4gICAgICByZXR1cm4gY29tYmluZUxhdGVzdChbZXZlbnQkLCB0aGlzLmNvbnRleHQkXSkucGlwZShcbiAgICAgICAgdGFwKChbLCBjb250ZXh0XSkgPT4ge1xuICAgICAgICAgIHRoaXMudXBkYXRlSXNTa2V0Y2hpbmcoZmFsc2UpO1xuXG4gICAgICAgICAgY29udGV4dD8uc3Ryb2tlKCk7XG4gICAgICAgICAgY29udGV4dD8uYmVnaW5QYXRoKCk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgKTtcblxuICByZWFkb25seSB1cGRhdGVDYW52YXNTaXplID0gdGhpcy5lZmZlY3QoXG4gICAgKGFyZ3MkOiBPYnNlcnZhYmxlPFtudW1iZXIsIG51bWJlcl0+KSA9PiB7XG4gICAgICByZXR1cm4gYXJncyQucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKChbd2lkdGgsIGhlaWdodF0pID0+IHtcbiAgICAgICAgICByZXR1cm4gY29tYmluZUxhdGVzdChbXG4gICAgICAgICAgICB0aGlzLmNhbnZhcyQsXG4gICAgICAgICAgICB0aGlzLmNvbnRleHQkLFxuICAgICAgICAgICAgb2Yod2lkdGgpLFxuICAgICAgICAgICAgb2YoaGVpZ2h0KSxcbiAgICAgICAgICBdKTtcbiAgICAgICAgfSksXG4gICAgICAgIGZpbHRlcihcbiAgICAgICAgICAvKiBlc2xpbnQtZGlzYWJsZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tdW51c2VkLXZhcnMgKi9cbiAgICAgICAgICAoW2NhbnZhcywgY29udGV4dCwgd2lkdGgsIGhlaWdodF0pID0+XG4gICAgICAgICAgICBjYW52YXMgIT09IG51bGwgJiYgY29udGV4dCAhPT0gbnVsbFxuICAgICAgICApLFxuICAgICAgICB0YXAoKFtjYW52YXMsIGNvbnRleHQsIHdpZHRoLCBoZWlnaHRdKSA9PiB7XG4gICAgICAgICAgLy8gUmVzaXppbmcgdGhlIGNhbnZhcyB3aWxsIGNsZWFyIGl0cyBjb250ZW50cywgc28gc3RvcmUgdGhlIGN1cnJlbnRcbiAgICAgICAgICAvLyBjYW52YXMgY29udGVudHMgYmVmb3JlIHJlc2l6aW5nIHNvIHRoZXkgY2FuIGJlIHJlc3RvcmVkIGFmdGVyLlxuICAgICAgICAgIGNvbnN0IGN1cnJlbnRDYW52YXNDb250ZW50ID0gY29udGV4dCEuZ2V0SW1hZ2VEYXRhKFxuICAgICAgICAgICAgMCxcbiAgICAgICAgICAgIDAsXG4gICAgICAgICAgICBjYW52YXMhLndpZHRoLFxuICAgICAgICAgICAgY2FudmFzIS5oZWlnaHRcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgLy8gTm93IHJlc2l6ZSB0aGUgY2FudmFzXG4gICAgICAgICAgY2FudmFzIS53aWR0aCA9IHdpZHRoO1xuICAgICAgICAgIGNhbnZhcyEuaGVpZ2h0ID0gaGVpZ2h0O1xuXG4gICAgICAgICAgLy8gUmVhcHBseSBzYXZlZCBjb250ZW50cy9cbiAgICAgICAgICBjb250ZXh0IS5wdXRJbWFnZURhdGEoY3VycmVudENhbnZhc0NvbnRlbnQsIDAsIDApO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICk7XG5cbiAgLyoqXG4gICAqICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tK1xuICAgKiBDTEFTUyBNRVRIT0RTXG4gICAqICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tK1xuICAgKi9cblxuICAvKipcbiAgICogVGFrZXMgYSBtb3VzZW1vdmUgb3IgdG91Y2htb3ZlIGV2ZW50IGFuZCByZXR1cm4gdGhlIGNvcnJlc3BvbmRpbmcgcG9zaXRpb25cbiAgICogb24gdGhlIHNjcmVlbiB3aGVyZSB0aGUgZXZlbnQgb2NjdXJyZWQuXG4gICAqL1xuICBwcml2YXRlIGV2ZW50UG9zaXRpb24oZXZlbnQ6IE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50KToge1xuICAgIHg6IG51bWJlcjtcbiAgICB5OiBudW1iZXI7XG4gIH0ge1xuICAgIGNvbnN0IGlzVG91Y2hFdmVudCA9IGV2ZW50IGluc3RhbmNlb2YgVG91Y2hFdmVudDtcblxuICAgIGNvbnN0IG5ld1ggPSBpc1RvdWNoRXZlbnRcbiAgICAgID8gKGV2ZW50IGFzIFRvdWNoRXZlbnQpLnRvdWNoZXNbMF0ucGFnZVhcbiAgICAgIDogKGV2ZW50IGFzIE1vdXNlRXZlbnQpLmNsaWVudFg7XG4gICAgY29uc3QgbmV3WSA9IGlzVG91Y2hFdmVudFxuICAgICAgPyAoZXZlbnQgYXMgVG91Y2hFdmVudCkudG91Y2hlc1swXS5wYWdlWVxuICAgICAgOiAoZXZlbnQgYXMgTW91c2VFdmVudCkuY2xpZW50WTtcblxuICAgIHJldHVybiB7XG4gICAgICB4OiBuZXdYLFxuICAgICAgeTogbmV3WSxcbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRFbGVtZW50U2l6ZU1pbnVzUGFkZGluZyhlbGVtZW50OiBIVE1MRWxlbWVudCkge1xuICAgIGNvbnN0IGNvbXB1dGVkU3R5bGUgPSB0aGlzLndpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGVsZW1lbnQpO1xuICAgIGNvbnN0IHdpZHRoID1cbiAgICAgIGVsZW1lbnQuY2xpZW50V2lkdGggLVxuICAgICAgKHBhcnNlRmxvYXQoY29tcHV0ZWRTdHlsZS5wYWRkaW5nTGVmdCkgK1xuICAgICAgICBwYXJzZUZsb2F0KGNvbXB1dGVkU3R5bGUucGFkZGluZ1JpZ2h0KSk7XG4gICAgY29uc3QgaGVpZ2h0ID1cbiAgICAgIGVsZW1lbnQuY2xpZW50SGVpZ2h0IC1cbiAgICAgIChwYXJzZUZsb2F0KGNvbXB1dGVkU3R5bGUucGFkZGluZ1RvcCkgK1xuICAgICAgICBwYXJzZUZsb2F0KGNvbXB1dGVkU3R5bGUucGFkZGluZ0JvdHRvbSkpO1xuICAgIHJldHVybiB7d2lkdGgsIGhlaWdodH0gYXMgU2l6ZTtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHN1cGVyKElOSVRJQUxfU1RBVEUpO1xuICB9XG59XG4iXX0=
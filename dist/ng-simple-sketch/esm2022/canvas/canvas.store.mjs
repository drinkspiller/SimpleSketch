import { Injectable, inject } from '@angular/core';
import { ComponentStore } from '@ngrx/component-store';
import { BehaviorSubject, combineLatest, debounceTime, filter, fromEvent, of, switchMap, takeUntil, tap, } from 'rxjs';
import { WINDOW } from '../injection-tokens';
import * as i0 from "@angular/core";
export var Mode;
(function (Mode) {
    Mode["ERASE"] = "erase";
    Mode["SKETCH"] = "sketch";
})(Mode || (Mode = {}));
const INITIAL_STATE = {
    backgroundColor: '#000000',
    canvasOffsetX: 0,
    canvasOffsetY: 0,
    isSketching: false,
    lineWidth: 5,
    mode: Mode.SKETCH,
    paintColor: '#ffffff',
    startX: 0,
    startY: 0,
};
export class SimpleSketchCanvasStore extends ComponentStore {
    canvas$ = new BehaviorSubject(null);
    context$ = new BehaviorSubject(null);
    window = inject(WINDOW);
    /**
     * +-------------------------------------------+
     * SELECTORS
     * +-------------------------------------------+
     */
    backgroundColor$ = this.select(state => state.backgroundColor);
    paintColor$ = this.select(state => state.paintColor);
    canvasOffsetX$ = this.select(state => state.canvasOffsetX);
    canvasOffsetY$ = this.select(state => state.canvasOffsetY);
    isSketching$ = this.select(state => state.isSketching);
    lineWidth$ = this.select(state => state.lineWidth);
    mode$ = this.select(state => state.mode);
    /**
     * +-------------------------------------------+
     * UPDATERS
     * +-------------------------------------------+
     */
    updateBackGroundColor = this.updater((state, newBackgroundColor) => ({
        ...state,
        backgroundColor: newBackgroundColor,
    }));
    updateIsSketching = this.updater((state, isSketching) => ({
        ...state,
        isSketching,
    }));
    updateCanvasOffsetX = this.updater((state, newCanvasOffsetX) => ({
        ...state,
        canvasOffsetX: newCanvasOffsetX,
    }));
    updateCanvasOffsetY = this.updater((state, newCanvasOffsetY) => ({
        ...state,
        canvasOffsetY: newCanvasOffsetY,
    }));
    updatePaintColor = this.updater((state, newPaintColor) => ({
        ...state,
        paintColor: newPaintColor,
    }));
    updateMode = this.updater((state, newMode) => ({
        ...state,
        mode: newMode,
    }));
    updateStartX = this.updater((state, newStartX) => ({
        ...state,
        startX: newStartX,
    }));
    updateStartY = this.updater((state, newStartY) => ({
        ...state,
        startY: newStartY,
    }));
    /**
     * +-------------------------------------------+
     * EFFECTS
     * +-------------------------------------------+
     */
    applyBackgroundColor = this.effect(() => {
        return combineLatest([this.backgroundColor$, this.canvas$]).pipe(tap(([color, canvas]) => {
            if (canvas) {
                canvas.style.backgroundColor = color;
            }
        }));
    });
    clearCanvas = this.effect(trigger$ => combineLatest([trigger$, this.context$, this.canvas$]).pipe(tap(([, context, canvas]) => {
        if (context && canvas) {
            context.clearRect(0, 0, canvas.width, canvas.height);
        }
    })));
    init = this.effect((data$) => {
        return data$.pipe(tap(([canvas, backgroundColor, paintColor]) => {
            const context = canvas.getContext('2d');
            this.canvas$.next(canvas);
            this.context$.next(context);
            const hostElement = canvas.parentElement;
            this.updateCanvasSize([
                hostElement.offsetWidth,
                hostElement.offsetHeight,
            ]);
            this.updateCanvasOffsetX(canvas.offsetLeft);
            this.updateCanvasOffsetY(canvas.offsetTop);
            this.updateBackGroundColor(backgroundColor);
            this.updatePaintColor(paintColor);
            this.applyBackgroundColor();
            fromEvent(this.window, 'resize')
                .pipe(takeUntil(this.destroy$), debounceTime(75))
                .subscribe(() => {
                this.updateCanvasSize([
                    hostElement.offsetWidth,
                    hostElement.offsetHeight,
                ]);
            });
        }));
    });
    sketch = this.effect((event$) => {
        return combineLatest([
            event$,
            this.context$,
            this.isSketching$,
            this.lineWidth$,
            this.canvasOffsetX$,
            this.canvasOffsetY$,
            this.paintColor$,
            this.mode$,
        ]).pipe(tap(([event, context, isSketching, lineWidth, canvasOffsetX, canvasOffsetY, paintColor, mode,]) => {
            if (!isSketching || context === null)
                return;
            context.globalCompositeOperation =
                mode === Mode.SKETCH ? 'source-over' : 'destination-out';
            context.lineWidth =
                mode === Mode.SKETCH ? lineWidth : lineWidth * 1.7;
            context.lineCap = 'round';
            context.strokeStyle = paintColor;
            const screenPosition = this.eventPosition(event);
            context.lineTo(screenPosition.x - canvasOffsetX, screenPosition.y - canvasOffsetY);
            context.stroke();
        }));
    });
    startSketch = this.effect((event$) => {
        return event$.pipe(tap(event => {
            const screenPosition = this.eventPosition(event);
            this.updateIsSketching(true);
            this.updateStartX(screenPosition.x);
            this.updateStartY(screenPosition.y);
        }));
    });
    stopSketch = this.effect((event$) => {
        return combineLatest([event$, this.context$]).pipe(tap(([, context]) => {
            this.updateIsSketching(false);
            if (context === null)
                return;
            context.stroke();
            context.beginPath();
        }));
    });
    updateCanvasSize = this.effect((args$) => {
        return args$.pipe(switchMap(([width, height]) => {
            return combineLatest([
                this.canvas$,
                this.context$,
                of(width),
                of(height),
            ]);
        }), filter(([canvas, context, width, height]) => canvas !== null && context !== null), tap(([canvas, context, width, height]) => {
            // Resizing the canvas will clear its contents, so store the current
            // canvas contents before resizing so they can be restored after.
            const currentCanvasContent = context.getImageData(0, 0, canvas.width, canvas.height);
            // Now resize the canvas
            canvas.width = width;
            canvas.height = height;
            // Reapply saved contents/
            context.putImageData(currentCanvasContent, 0, 0);
        }));
    });
    /**
     * +-------------------------------------------+
     * CLASS METHODS
     * +-------------------------------------------+
     */
    /**
     * Takes a mousemove or touchmove event and return the corresponding position
     * on the screen where the event occurred.
     */
    eventPosition(event) {
        const isTouchEvent = event instanceof TouchEvent;
        const newX = isTouchEvent
            ? event.touches[0].pageX
            : event.clientX;
        const newY = isTouchEvent
            ? event.touches[0].pageY
            : event.clientY;
        return {
            x: newX,
            y: newY,
        };
    }
    constructor() {
        super(INITIAL_STATE);
    }
    static ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: SimpleSketchCanvasStore, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
    static ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: SimpleSketchCanvasStore });
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.0.8", ngImport: i0, type: SimpleSketchCanvasStore, decorators: [{
            type: Injectable
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FudmFzLnN0b3JlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL3NpbXBsZS1za2V0Y2gvY2FudmFzL2NhbnZhcy5zdG9yZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsVUFBVSxFQUFFLE1BQU0sRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNqRCxPQUFPLEVBQUMsY0FBYyxFQUFDLE1BQU0sdUJBQXVCLENBQUM7QUFDckQsT0FBTyxFQUNMLGVBQWUsRUFFZixhQUFhLEVBQ2IsWUFBWSxFQUNaLE1BQU0sRUFDTixTQUFTLEVBQ1QsRUFBRSxFQUNGLFNBQVMsRUFDVCxTQUFTLEVBQ1QsR0FBRyxHQUNKLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUFDLE1BQU0sRUFBQyxNQUFNLHFCQUFxQixDQUFDOztBQUUzQyxNQUFNLENBQU4sSUFBWSxJQUdYO0FBSEQsV0FBWSxJQUFJO0lBQ2QsdUJBQWUsQ0FBQTtJQUNmLHlCQUFpQixDQUFBO0FBQ25CLENBQUMsRUFIVyxJQUFJLEtBQUosSUFBSSxRQUdmO0FBY0QsTUFBTSxhQUFhLEdBQTRCO0lBQzdDLGVBQWUsRUFBRSxTQUFTO0lBQzFCLGFBQWEsRUFBRSxDQUFDO0lBQ2hCLGFBQWEsRUFBRSxDQUFDO0lBQ2hCLFdBQVcsRUFBRSxLQUFLO0lBQ2xCLFNBQVMsRUFBRSxDQUFDO0lBQ1osSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNO0lBQ2pCLFVBQVUsRUFBRSxTQUFTO0lBQ3JCLE1BQU0sRUFBRSxDQUFDO0lBQ1QsTUFBTSxFQUFFLENBQUM7Q0FDVixDQUFDO0FBR0YsTUFBTSxPQUFPLHVCQUF3QixTQUFRLGNBQXVDO0lBQzFFLE9BQU8sR0FBRyxJQUFJLGVBQWUsQ0FBMkIsSUFBSSxDQUFDLENBQUM7SUFDOUQsUUFBUSxHQUFHLElBQUksZUFBZSxDQUFrQyxJQUFJLENBQUMsQ0FBQztJQUN0RSxNQUFNLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FB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VSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7SW5qZWN0YWJsZSwgaW5qZWN0fSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7Q29tcG9uZW50U3RvcmV9IGZyb20gJ0BuZ3J4L2NvbXBvbmVudC1zdG9yZSc7XG5pbXBvcnQge1xuICBCZWhhdmlvclN1YmplY3QsXG4gIE9ic2VydmFibGUsXG4gIGNvbWJpbmVMYXRlc3QsXG4gIGRlYm91bmNlVGltZSxcbiAgZmlsdGVyLFxuICBmcm9tRXZlbnQsXG4gIG9mLFxuICBzd2l0Y2hNYXAsXG4gIHRha2VVbnRpbCxcbiAgdGFwLFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7V0lORE9XfSBmcm9tICcuLi9pbmplY3Rpb24tdG9rZW5zJztcblxuZXhwb3J0IGVudW0gTW9kZSB7XG4gIEVSQVNFID0gJ2VyYXNlJyxcbiAgU0tFVENIID0gJ3NrZXRjaCcsXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU2ltcGxlU2tldGNoQ2FudmFzU3RhdGUge1xuICBiYWNrZ3JvdW5kQ29sb3I6IHN0cmluZztcbiAgY2FudmFzT2Zmc2V0WDogbnVtYmVyO1xuICBjYW52YXNPZmZzZXRZOiBudW1iZXI7XG4gIGlzU2tldGNoaW5nOiBib29sZWFuO1xuICBsaW5lV2lkdGg6IG51bWJlcjtcbiAgbW9kZTogTW9kZTtcbiAgcGFpbnRDb2xvcjogc3RyaW5nO1xuICBzdGFydFg6IG51bWJlcjtcbiAgc3RhcnRZOiBudW1iZXI7XG59XG5cbmNvbnN0IElOSVRJQUxfU1RBVEU6IFNpbXBsZVNrZXRjaENhbnZhc1N0YXRlID0ge1xuICBiYWNrZ3JvdW5kQ29sb3I6ICcjMDAwMDAwJyxcbiAgY2FudmFzT2Zmc2V0WDogMCxcbiAgY2FudmFzT2Zmc2V0WTogMCxcbiAgaXNTa2V0Y2hpbmc6IGZhbHNlLFxuICBsaW5lV2lkdGg6IDUsXG4gIG1vZGU6IE1vZGUuU0tFVENILFxuICBwYWludENvbG9yOiAnI2ZmZmZmZicsXG4gIHN0YXJ0WDogMCxcbiAgc3RhcnRZOiAwLFxufTtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFNpbXBsZVNrZXRjaENhbnZhc1N0b3JlIGV4dGVuZHMgQ29tcG9uZW50U3RvcmU8U2ltcGxlU2tldGNoQ2FudmFzU3RhdGU+IHtcbiAgcHJpdmF0ZSBjYW52YXMkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxIVE1MQ2FudmFzRWxlbWVudCB8IG51bGw+KG51bGwpO1xuICBwcml2YXRlIGNvbnRleHQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQgfCBudWxsPihudWxsKTtcbiAgcHJpdmF0ZSB3aW5kb3cgPSBpbmplY3QoV0lORE9XKTtcblxuICAvKipcbiAgICogKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rXG4gICAqIFNFTEVDVE9SU1xuICAgKiArLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLStcbiAgICovXG4gIHJlYWRvbmx5IGJhY2tncm91bmRDb2xvciQ6IE9ic2VydmFibGU8c3RyaW5nPiA9IHRoaXMuc2VsZWN0KFxuICAgIHN0YXRlID0+IHN0YXRlLmJhY2tncm91bmRDb2xvclxuICApO1xuXG4gIHJlYWRvbmx5IHBhaW50Q29sb3IkOiBPYnNlcnZhYmxlPHN0cmluZz4gPSB0aGlzLnNlbGVjdChcbiAgICBzdGF0ZSA9PiBzdGF0ZS5wYWludENvbG9yXG4gICk7XG5cbiAgcmVhZG9ubHkgY2FudmFzT2Zmc2V0WCQ6IE9ic2VydmFibGU8bnVtYmVyPiA9IHRoaXMuc2VsZWN0KFxuICAgIHN0YXRlID0+IHN0YXRlLmNhbnZhc09mZnNldFhcbiAgKTtcblxuICByZWFkb25seSBjYW52YXNPZmZzZXRZJDogT2JzZXJ2YWJsZTxudW1iZXI+ID0gdGhpcy5zZWxlY3QoXG4gICAgc3RhdGUgPT4gc3RhdGUuY2FudmFzT2Zmc2V0WVxuICApO1xuXG4gIHJlYWRvbmx5IGlzU2tldGNoaW5nJDogT2JzZXJ2YWJsZTxib29sZWFuPiA9IHRoaXMuc2VsZWN0KFxuICAgIHN0YXRlID0+IHN0YXRlLmlzU2tldGNoaW5nXG4gICk7XG5cbiAgcmVhZG9ubHkgbGluZVdpZHRoJDogT2JzZXJ2YWJsZTxudW1iZXI+ID0gdGhpcy5zZWxlY3QoXG4gICAgc3RhdGUgPT4gc3RhdGUubGluZVdpZHRoXG4gICk7XG5cbiAgcmVhZG9ubHkgbW9kZSQ6IE9ic2VydmFibGU8TW9kZT4gPSB0aGlzLnNlbGVjdChzdGF0ZSA9PiBzdGF0ZS5tb2RlKTtcblxuICAvKipcbiAgICogKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rXG4gICAqIFVQREFURVJTXG4gICAqICstLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tK1xuICAgKi9cbiAgcmVhZG9ubHkgdXBkYXRlQmFja0dyb3VuZENvbG9yID0gdGhpcy51cGRhdGVyKFxuICAgIChzdGF0ZSwgbmV3QmFja2dyb3VuZENvbG9yOiBzdHJpbmcpID0+ICh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGJhY2tncm91bmRDb2xvcjogbmV3QmFja2dyb3VuZENvbG9yLFxuICAgIH0pXG4gICk7XG5cbiAgcmVhZG9ubHkgdXBkYXRlSXNTa2V0Y2hpbmcgPSB0aGlzLnVwZGF0ZXIoKHN0YXRlLCBpc1NrZXRjaGluZzogYm9vbGVhbikgPT4gKHtcbiAgICAuLi5zdGF0ZSxcbiAgICBpc1NrZXRjaGluZyxcbiAgfSkpO1xuXG4gIHJlYWRvbmx5IHVwZGF0ZUNhbnZhc09mZnNldFggPSB0aGlzLnVwZGF0ZXIoXG4gICAgKHN0YXRlLCBuZXdDYW52YXNPZmZzZXRYOiBudW1iZXIpID0+ICh7XG4gICAgICAuLi5zdGF0ZSxcbiAgICAgIGNhbnZhc09mZnNldFg6IG5ld0NhbnZhc09mZnNldFgsXG4gICAgfSlcbiAgKTtcblxuICByZWFkb25seSB1cGRhdGVDYW52YXNPZmZzZXRZID0gdGhpcy51cGRhdGVyKFxuICAgIChzdGF0ZSwgbmV3Q2FudmFzT2Zmc2V0WTogbnVtYmVyKSA9PiAoe1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBjYW52YXNPZmZzZXRZOiBuZXdDYW52YXNPZmZzZXRZLFxuICAgIH0pXG4gICk7XG5cbiAgcmVhZG9ubHkgdXBkYXRlUGFpbnRDb2xvciA9IHRoaXMudXBkYXRlcigoc3RhdGUsIG5ld1BhaW50Q29sb3I6IHN0cmluZykgPT4gKHtcbiAgICAuLi5zdGF0ZSxcbiAgICBwYWludENvbG9yOiBuZXdQYWludENvbG9yLFxuICB9KSk7XG5cbiAgcmVhZG9ubHkgdXBkYXRlTW9kZSA9IHRoaXMudXBkYXRlcigoc3RhdGUsIG5ld01vZGU6IE1vZGUpID0+ICh7XG4gICAgLi4uc3RhdGUsXG4gICAgbW9kZTogbmV3TW9kZSxcbiAgfSkpO1xuXG4gIHJlYWRvbmx5IHVwZGF0ZVN0YXJ0WCA9IHRoaXMudXBkYXRlcigoc3RhdGUsIG5ld1N0YXJ0WDogbnVtYmVyKSA9PiAoe1xuICAgIC4uLnN0YXRlLFxuICAgIHN0YXJ0WDogbmV3U3RhcnRYLFxuICB9KSk7XG5cbiAgcmVhZG9ubHkgdXBkYXRlU3RhcnRZID0gdGhpcy51cGRhdGVyKChzdGF0ZSwgbmV3U3RhcnRZOiBudW1iZXIpID0+ICh7XG4gICAgLi4uc3RhdGUsXG4gICAgc3RhcnRZOiBuZXdTdGFydFksXG4gIH0pKTtcblxuICAvKipcbiAgICogKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rXG4gICAqIEVGRkVDVFNcbiAgICogKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rXG4gICAqL1xuICByZWFkb25seSBhcHBseUJhY2tncm91bmRDb2xvciA9IHRoaXMuZWZmZWN0KCgpID0+IHtcbiAgICByZXR1cm4gY29tYmluZUxhdGVzdChbdGhpcy5iYWNrZ3JvdW5kQ29sb3IkLCB0aGlzLmNhbnZhcyRdKS5waXBlKFxuICAgICAgdGFwKChbY29sb3IsIGNhbnZhc10pID0+IHtcbiAgICAgICAgaWYgKGNhbnZhcykge1xuICAgICAgICAgIGNhbnZhcy5zdHlsZS5iYWNrZ3JvdW5kQ29sb3IgPSBjb2xvcjtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuICB9KTtcblxuICByZWFkb25seSBjbGVhckNhbnZhcyA9IHRoaXMuZWZmZWN0KHRyaWdnZXIkID0+XG4gICAgY29tYmluZUxhdGVzdChbdHJpZ2dlciQsIHRoaXMuY29udGV4dCQsIHRoaXMuY2FudmFzJF0pLnBpcGUoXG4gICAgICB0YXAoKFssIGNvbnRleHQsIGNhbnZhc10pID0+IHtcbiAgICAgICAgaWYgKGNvbnRleHQgJiYgY2FudmFzKSB7XG4gICAgICAgICAgY29udGV4dC5jbGVhclJlY3QoMCwgMCwgY2FudmFzLndpZHRoLCBjYW52YXMuaGVpZ2h0KTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApXG4gICk7XG5cbiAgcmVhZG9ubHkgaW5pdCA9IHRoaXMuZWZmZWN0KFxuICAgIChkYXRhJDogT2JzZXJ2YWJsZTxbSFRNTENhbnZhc0VsZW1lbnQsIHN0cmluZywgc3RyaW5nXT4pID0+IHtcbiAgICAgIHJldHVybiBkYXRhJC5waXBlKFxuICAgICAgICB0YXAoKFtjYW52YXMsIGJhY2tncm91bmRDb2xvciwgcGFpbnRDb2xvcl0pID0+IHtcbiAgICAgICAgICBjb25zdCBjb250ZXh0ID0gY2FudmFzLmdldENvbnRleHQoJzJkJyk7XG5cbiAgICAgICAgICB0aGlzLmNhbnZhcyQubmV4dChjYW52YXMpO1xuICAgICAgICAgIHRoaXMuY29udGV4dCQubmV4dChjb250ZXh0KTtcblxuICAgICAgICAgIGNvbnN0IGhvc3RFbGVtZW50ID0gY2FudmFzLnBhcmVudEVsZW1lbnQgYXMgSFRNTEVsZW1lbnQ7XG4gICAgICAgICAgdGhpcy51cGRhdGVDYW52YXNTaXplKFtcbiAgICAgICAgICAgIGhvc3RFbGVtZW50Lm9mZnNldFdpZHRoLFxuICAgICAgICAgICAgaG9zdEVsZW1lbnQub2Zmc2V0SGVpZ2h0LFxuICAgICAgICAgIF0pO1xuXG4gICAgICAgICAgdGhpcy51cGRhdGVDYW52YXNPZmZzZXRYKGNhbnZhcy5vZmZzZXRMZWZ0KTtcbiAgICAgICAgICB0aGlzLnVwZGF0ZUNhbnZhc09mZnNldFkoY2FudmFzLm9mZnNldFRvcCk7XG4gICAgICAgICAgdGhpcy51cGRhdGVCYWNrR3JvdW5kQ29sb3IoYmFja2dyb3VuZENvbG9yKTtcbiAgICAgICAgICB0aGlzLnVwZGF0ZVBhaW50Q29sb3IocGFpbnRDb2xvcik7XG5cbiAgICAgICAgICB0aGlzLmFwcGx5QmFja2dyb3VuZENvbG9yKCk7XG5cbiAgICAgICAgICBmcm9tRXZlbnQodGhpcy53aW5kb3csICdyZXNpemUnKVxuICAgICAgICAgICAgLnBpcGUodGFrZVVudGlsKHRoaXMuZGVzdHJveSQpLCBkZWJvdW5jZVRpbWUoNzUpKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMudXBkYXRlQ2FudmFzU2l6ZShbXG4gICAgICAgICAgICAgICAgaG9zdEVsZW1lbnQub2Zmc2V0V2lkdGgsXG4gICAgICAgICAgICAgICAgaG9zdEVsZW1lbnQub2Zmc2V0SGVpZ2h0LFxuICAgICAgICAgICAgICBdKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9KVxuICAgICAgKTtcbiAgICB9XG4gICk7XG5cbiAgcmVhZG9ubHkgc2tldGNoID0gdGhpcy5lZmZlY3QoXG4gICAgKGV2ZW50JDogT2JzZXJ2YWJsZTxNb3VzZUV2ZW50IHwgVG91Y2hFdmVudD4pID0+IHtcbiAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtcbiAgICAgICAgZXZlbnQkLFxuICAgICAgICB0aGlzLmNvbnRleHQkLFxuICAgICAgICB0aGlzLmlzU2tldGNoaW5nJCxcbiAgICAgICAgdGhpcy5saW5lV2lkdGgkLFxuICAgICAgICB0aGlzLmNhbnZhc09mZnNldFgkLFxuICAgICAgICB0aGlzLmNhbnZhc09mZnNldFkkLFxuICAgICAgICB0aGlzLnBhaW50Q29sb3IkLFxuICAgICAgICB0aGlzLm1vZGUkLFxuICAgICAgXSkucGlwZShcbiAgICAgICAgdGFwKFxuICAgICAgICAgIChbXG4gICAgICAgICAgICBldmVudCxcbiAgICAgICAgICAgIGNvbnRleHQsXG4gICAgICAgICAgICBpc1NrZXRjaGluZyxcbiAgICAgICAgICAgIGxpbmVXaWR0aCxcbiAgICAgICAgICAgIGNhbnZhc09mZnNldFgsXG4gICAgICAgICAgICBjYW52YXNPZmZzZXRZLFxuICAgICAgICAgICAgcGFpbnRDb2xvcixcbiAgICAgICAgICAgIG1vZGUsXG4gICAgICAgICAgXSkgPT4ge1xuICAgICAgICAgICAgaWYgKCFpc1NrZXRjaGluZyB8fCBjb250ZXh0ID09PSBudWxsKSByZXR1cm47XG4gICAgICAgICAgICBjb250ZXh0Lmdsb2JhbENvbXBvc2l0ZU9wZXJhdGlvbiA9XG4gICAgICAgICAgICAgIG1vZGUgPT09IE1vZGUuU0tFVENIID8gJ3NvdXJjZS1vdmVyJyA6ICdkZXN0aW5hdGlvbi1vdXQnO1xuICAgICAgICAgICAgY29udGV4dC5saW5lV2lkdGggPVxuICAgICAgICAgICAgICBtb2RlID09PSBNb2RlLlNLRVRDSCA/IGxpbmVXaWR0aCA6IGxpbmVXaWR0aCAqIDEuNztcbiAgICAgICAgICAgIGNvbnRleHQubGluZUNhcCA9ICdyb3VuZCc7XG4gICAgICAgICAgICBjb250ZXh0LnN0cm9rZVN0eWxlID0gcGFpbnRDb2xvcjtcblxuICAgICAgICAgICAgY29uc3Qgc2NyZWVuUG9zaXRpb24gPSB0aGlzLmV2ZW50UG9zaXRpb24oZXZlbnQpO1xuICAgICAgICAgICAgY29udGV4dC5saW5lVG8oXG4gICAgICAgICAgICAgIHNjcmVlblBvc2l0aW9uLnggLSBjYW52YXNPZmZzZXRYLFxuICAgICAgICAgICAgICBzY3JlZW5Qb3NpdGlvbi55IC0gY2FudmFzT2Zmc2V0WVxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIGNvbnRleHQuc3Ryb2tlKCk7XG4gICAgICAgICAgfVxuICAgICAgICApXG4gICAgICApO1xuICAgIH1cbiAgKTtcblxuICByZWFkb25seSBzdGFydFNrZXRjaCA9IHRoaXMuZWZmZWN0KFxuICAgIChldmVudCQ6IE9ic2VydmFibGU8TW91c2VFdmVudCB8IFRvdWNoRXZlbnQ+KSA9PiB7XG4gICAgICByZXR1cm4gZXZlbnQkLnBpcGUoXG4gICAgICAgIHRhcChldmVudCA9PiB7XG4gICAgICAgICAgY29uc3Qgc2NyZWVuUG9zaXRpb24gPSB0aGlzLmV2ZW50UG9zaXRpb24oXG4gICAgICAgICAgICBldmVudCBhcyB1bmtub3duIGFzIE1vdXNlRXZlbnQgfCBUb3VjaEV2ZW50XG4gICAgICAgICAgKTtcblxuICAgICAgICAgIHRoaXMudXBkYXRlSXNTa2V0Y2hpbmcodHJ1ZSk7XG4gICAgICAgICAgdGhpcy51cGRhdGVTdGFydFgoc2NyZWVuUG9zaXRpb24ueCk7XG4gICAgICAgICAgdGhpcy51cGRhdGVTdGFydFkoc2NyZWVuUG9zaXRpb24ueSk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgKTtcblxuICByZWFkb25seSBzdG9wU2tldGNoID0gdGhpcy5lZmZlY3QoXG4gICAgKGV2ZW50JDogT2JzZXJ2YWJsZTxNb3VzZUV2ZW50IHwgVG91Y2hFdmVudD4pID0+IHtcbiAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtldmVudCQsIHRoaXMuY29udGV4dCRdKS5waXBlKFxuICAgICAgICB0YXAoKFssIGNvbnRleHRdKSA9PiB7XG4gICAgICAgICAgdGhpcy51cGRhdGVJc1NrZXRjaGluZyhmYWxzZSk7XG5cbiAgICAgICAgICBpZiAoY29udGV4dCA9PT0gbnVsbCkgcmV0dXJuO1xuICAgICAgICAgIGNvbnRleHQuc3Ryb2tlKCk7XG4gICAgICAgICAgY29udGV4dC5iZWdpblBhdGgoKTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuICApO1xuXG4gIHJlYWRvbmx5IHVwZGF0ZUNhbnZhc1NpemUgPSB0aGlzLmVmZmVjdChcbiAgICAoYXJncyQ6IE9ic2VydmFibGU8W251bWJlciwgbnVtYmVyXT4pID0+IHtcbiAgICAgIHJldHVybiBhcmdzJC5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKFt3aWR0aCwgaGVpZ2h0XSkgPT4ge1xuICAgICAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtcbiAgICAgICAgICAgIHRoaXMuY2FudmFzJCxcbiAgICAgICAgICAgIHRoaXMuY29udGV4dCQsXG4gICAgICAgICAgICBvZih3aWR0aCksXG4gICAgICAgICAgICBvZihoZWlnaHQpLFxuICAgICAgICAgIF0pO1xuICAgICAgICB9KSxcbiAgICAgICAgZmlsdGVyKFxuICAgICAgICAgIChbY2FudmFzLCBjb250ZXh0LCB3aWR0aCwgaGVpZ2h0XSkgPT5cbiAgICAgICAgICAgIGNhbnZhcyAhPT0gbnVsbCAmJiBjb250ZXh0ICE9PSBudWxsXG4gICAgICAgICksXG4gICAgICAgIHRhcCgoW2NhbnZhcywgY29udGV4dCwgd2lkdGgsIGhlaWdodF0pID0+IHtcbiAgICAgICAgICAvLyBSZXNpemluZyB0aGUgY2FudmFzIHdpbGwgY2xlYXIgaXRzIGNvbnRlbnRzLCBzbyBzdG9yZSB0aGUgY3VycmVudFxuICAgICAgICAgIC8vIGNhbnZhcyBjb250ZW50cyBiZWZvcmUgcmVzaXppbmcgc28gdGhleSBjYW4gYmUgcmVzdG9yZWQgYWZ0ZXIuXG4gICAgICAgICAgY29uc3QgY3VycmVudENhbnZhc0NvbnRlbnQgPSBjb250ZXh0IS5nZXRJbWFnZURhdGEoXG4gICAgICAgICAgICAwLFxuICAgICAgICAgICAgMCxcbiAgICAgICAgICAgIGNhbnZhcyEud2lkdGgsXG4gICAgICAgICAgICBjYW52YXMhLmhlaWdodFxuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBOb3cgcmVzaXplIHRoZSBjYW52YXNcbiAgICAgICAgICBjYW52YXMhLndpZHRoID0gd2lkdGg7XG4gICAgICAgICAgY2FudmFzIS5oZWlnaHQgPSBoZWlnaHQ7XG5cbiAgICAgICAgICAvLyBSZWFwcGx5IHNhdmVkIGNvbnRlbnRzL1xuICAgICAgICAgIGNvbnRleHQhLnB1dEltYWdlRGF0YShjdXJyZW50Q2FudmFzQ29udGVudCwgMCwgMCk7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgKTtcblxuICAvKipcbiAgICogKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rXG4gICAqIENMQVNTIE1FVEhPRFNcbiAgICogKy0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0rXG4gICAqL1xuXG4gIC8qKlxuICAgKiBUYWtlcyBhIG1vdXNlbW92ZSBvciB0b3VjaG1vdmUgZXZlbnQgYW5kIHJldHVybiB0aGUgY29ycmVzcG9uZGluZyBwb3NpdGlvblxuICAgKiBvbiB0aGUgc2NyZWVuIHdoZXJlIHRoZSBldmVudCBvY2N1cnJlZC5cbiAgICovXG4gIHByaXZhdGUgZXZlbnRQb3NpdGlvbihldmVudDogTW91c2VFdmVudCB8IFRvdWNoRXZlbnQpOiB7XG4gICAgeDogbnVtYmVyO1xuICAgIHk6IG51bWJlcjtcbiAgfSB7XG4gICAgY29uc3QgaXNUb3VjaEV2ZW50ID0gZXZlbnQgaW5zdGFuY2VvZiBUb3VjaEV2ZW50O1xuXG4gICAgY29uc3QgbmV3WCA9IGlzVG91Y2hFdmVudFxuICAgICAgPyAoZXZlbnQgYXMgVG91Y2hFdmVudCkudG91Y2hlc1swXS5wYWdlWFxuICAgICAgOiAoZXZlbnQgYXMgTW91c2VFdmVudCkuY2xpZW50WDtcbiAgICBjb25zdCBuZXdZID0gaXNUb3VjaEV2ZW50XG4gICAgICA/IChldmVudCBhcyBUb3VjaEV2ZW50KS50b3VjaGVzWzBdLnBhZ2VZXG4gICAgICA6IChldmVudCBhcyBNb3VzZUV2ZW50KS5jbGllbnRZO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHg6IG5ld1gsXG4gICAgICB5OiBuZXdZLFxuICAgIH07XG4gIH1cblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcihJTklUSUFMX1NUQVRFKTtcbiAgfVxufVxuIl19